<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Trackr</title>
  
<link rel="manifest" href="data:application/json,{%22name%22:%22Trackr%22,%22short_name%22:%22Trackr%22,%22description%22:%22Personal%20media%20tracker%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23000000%22,%22theme_color%22:%22%23e50914%22,%22orientation%22:%22portrait%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20512%20512'%3E%3Crect%20width='512'%20height='512'%20fill='%23000'/%3E%3Ctext%20x='50%25'%20y='55%25'%20font-size='280'%20text-anchor='middle'%20dy='.3em'%20font-family='Impact'%20fill='%23e50914'%3ET%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22,%22purpose%22:%22any%20maskable%22}]}">
<link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#141414">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --black:#000;--bg:#141414;--surface:#1a1a1a;
  --text:#e5e5e5;--muted:rgba(255,255,255,0.45);--white:#fff;
  --red:#e50914;--red2:#b81d24;--red-glow:rgba(108, 106, 106, 0.35);
  --c-movie:#e50914;--c-series:#0080ff;--c-anime:#9b59f5;--c-manga:#ff8c00;
  --s-ongoing:#22c55e;--s-finished:#e50914;--s-morecoming:#f59e0b;--s-abandoned:#6b7280;
  --font-d:'Bebas Neue',Impact,sans-serif;--font:'Inter',sans-serif;
  --nav-h:64px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{-webkit-tap-highlight-color:transparent;}
body{background:var(--black);color:var(--text);font-family:var(--font);font-size:14px;min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;overscroll-behavior:none;}

/* PAGE SYSTEM */
.page{position:fixed;inset:0;overflow-y:auto;overflow-x:hidden;background:var(--black);will-change:transform;transition:transform .32s cubic-bezier(0.4,0,0.2,1),opacity .32s;}
.page.hidden{pointer-events:none;}
.page-home{transform:translateX(0);}
.page-home.hidden{transform:translateX(-30%);opacity:0;}
.page-secondary{transform:translateX(100%);}
.page-secondary.active{transform:translateX(0);}
.page-secondary.swipe-back{transform:translateX(100%);opacity:0;}

/* RIPPLE */
.ripple-host{position:relative;overflow:hidden;}
.ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,0.18);transform:scale(0);animation:ripple-anim .5s linear;pointer-events:none;}
@keyframes ripple-anim{to{transform:scale(4);opacity:0;}}

/* BOTTOM NAV */
.bot-nav{position:fixed;bottom:0;left:0;right:0;z-index:200;height:var(--nav-h);background:rgba(10,10,10,0.97);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,0.07);display:flex;align-items:center;justify-content:space-around;padding-bottom:env(safe-area-inset-bottom);}
.bot-nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;padding:8px 0;cursor:pointer;color:var(--muted);transition:color .2s;position:relative;}
.bot-nav-item.active{color:var(--red);}
.bot-nav-item svg{transition:transform .2s;}
.bot-nav-item.active svg{transform:scale(1.12);}
.bot-nav-label{font-size:10px;font-weight:600;letter-spacing:0.3px;}
.bot-nav-pip{position:absolute;top:6px;width:4px;height:4px;border-radius:50%;background:var(--red);opacity:0;transition:opacity .2s;}
.bot-nav-item.active .bot-nav-pip{opacity:1;}
.bot-add{width:48px;height:48px;border-radius:50%;background:var(--red);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px var(--red-glow);transition:transform .15s,background .15s;}
.bot-add:active{transform:scale(0.92);}

/* HEADER */
.nf-header{position:sticky;top:0;z-index:100;display:flex;align-items:center;padding:0 16px;height:56px;background:linear-gradient(180deg,rgba(0,0,0,0.98),rgba(0,0,0,0.7));backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,0.05);}
.nf-logo{font-family:var(--font-d);font-size:30px;letter-spacing:3px;color:var(--red);flex:1;text-shadow:0 2px 20px var(--red-glow);line-height:1;}
.nf-header-right{display:flex;align-items:center;gap:6px;}
.nf-icon-btn{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);color:var(--text);cursor:pointer;flex-shrink:0;transition:background .15s,border-color .15s;}
.nf-icon-btn:hover{background:rgba(255,255,255,0.15);border-color:rgba(255,255,255,0.2);}
.nf-icon-btn.del:hover{background:rgba(229,9,20,0.18);border-color:rgba(229,9,20,0.3);color:var(--red);}
.nf-icon-btn.on{background:rgba(229,9,20,0.15);border-color:rgba(229,9,20,0.4);color:var(--red);}
.nf-hdiv{width:1px;height:18px;background:rgba(255,255,255,0.1);margin:0 2px;}

/* CONTROLS */
.nf-controls{position:sticky;top:56px;z-index:90;background:rgba(0,0,0,0.95);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,0.06);padding:10px 16px 12px;display:flex;flex-direction:column;gap:10px;}
.nf-search-row{display:flex;gap:8px;align-items:center;}
.nf-search-wrap{position:relative;flex:1;}
.nf-search-wrap .si{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none;}
#searchInput{width:100%;padding:10px 14px 10px 36px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:var(--white);font-family:var(--font);font-size:13px;outline:none;transition:background .2s,border-color .2s;}
#searchInput:focus{background:rgba(255,255,255,0.11);border-color:rgba(255,255,255,0.35);}
#searchInput::placeholder{color:var(--muted);}
.sort-wrap{position:relative;flex-shrink:0;}
.sort-btn{display:flex;align-items:center;gap:6px;height:38px;padding:0 12px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:var(--text);font-family:var(--font);font-size:12px;font-weight:500;cursor:pointer;white-space:nowrap;user-select:none;transition:background .15s,border-color .15s;}
.sort-btn:hover,.sort-btn.open{background:rgba(255,255,255,0.12);border-color:rgba(255,255,255,0.3);}
.sort-val{color:var(--red);font-size:11px;font-weight:600;}
.sort-drop{position:absolute;top:calc(100% + 6px);right:0;background:#1c1c1c;border:1px solid rgba(255,255,255,0.12);border-radius:14px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,0.9);z-index:200;min-width:168px;display:none;}
.sort-drop.open{display:block;}
.sort-opt{padding:12px 16px;font-size:13px;cursor:pointer;color:rgba(255,255,255,0.65);display:flex;align-items:center;justify-content:space-between;transition:background .1s;}
.sort-opt:hover{background:rgba(255,255,255,0.07);color:var(--white);}
.sort-opt.sel{color:var(--white);font-weight:600;}
.sort-opt.sel::after{content:'';width:6px;height:6px;border-radius:50%;background:var(--red);}
.nf-chips{display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;}
.nf-chips::-webkit-scrollbar{display:none;}
.nf-chip{padding:5px 14px;border-radius:20px;border:1px solid rgba(255,255,255,0.18);background:transparent;color:rgba(255,255,255,0.65);font-size:12px;font-weight:500;cursor:pointer;white-space:nowrap;flex-shrink:0;transition:all .15s;user-select:none;}
.nf-chip:hover{border-color:rgba(255,255,255,0.5);color:var(--white);background:rgba(255,255,255,0.07);}
.nf-chip.active{background:var(--white);color:var(--black);border-color:var(--white);font-weight:700;}

/* TABS */
.nf-tabs{display:flex;padding:0 4px;background:rgba(0,0,0,0.92);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,0.07);position:sticky;top:160px;z-index:89;overflow-x:auto;scrollbar-width:none;}
.nf-tabs::-webkit-scrollbar{display:none;}
.nf-tab{padding:12px 12px;font-size:12px;font-weight:600;letter-spacing:0.2px;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:color .15s,border-color .15s;user-select:none;white-space:nowrap;flex-shrink:0;}
.nf-tab:hover{color:rgba(255,255,255,0.85);}
.nf-tab.active{color:var(--white);border-bottom-color:var(--red);}
.nf-tab-badge{display:inline-flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.1);border-radius:3px;font-size:10px;padding:1px 5px;margin-left:5px;font-weight:600;color:var(--muted);vertical-align:middle;}
.nf-tab.active .nf-tab-badge{background:rgba(229,9,20,0.2);color:var(--red);}

/* GRID */
.nf-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;padding:14px 14px 90px;}
.nf-empty{grid-column:1/-1;text-align:center;padding:64px 24px;color:var(--muted);}
.nf-empty-icon{font-size:52px;opacity:0.2;margin-bottom:16px;}
.nf-empty p{font-size:15px;line-height:1.7;}

/* CARD */
.nf-card{position:relative;cursor:pointer;aspect-ratio:2/3;background:#1c1c1c;border-radius:12px;overflow:hidden;transition:transform .22s cubic-bezier(0.25,0.46,0.45,0.94);}
.nf-card:active{transform:scale(0.96);}
.nf-card img{width:100%;height:100%;object-fit:cover;display:block;transition:filter .22s;}
.nf-card-ph{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:12px;background:linear-gradient(145deg,#1a1a2e,#16213e);}
.nf-card-ph-icon{font-size:28px;opacity:0.4;}
.nf-card-ph-name{font-size:10px;font-weight:700;color:rgba(255,255,255,0.4);text-align:center;line-height:1.3;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.nf-card-bottom{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,0.97) 0%,rgba(0,0,0,0.7) 50%,transparent 100%);padding:24px 8px 8px;}
.nf-card-name{font-size:10px;font-weight:700;color:#fff;line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-shadow:0 1px 4px rgba(0,0,0,0.9);}
.nf-card-lastseen{font-size:9px;color:rgba(255,255,255,0.5);margin-top:2px;font-weight:500;}
.nf-card-tag{position:absolute;top:6px;left:6px;font-size:8px;font-weight:800;letter-spacing:0.5px;text-transform:uppercase;border-radius:6px;padding:3px 7px;z-index:2;color:#fff;}
.nf-tag-movie{background:var(--c-movie);}
.nf-tag-series{background:var(--c-series);}
.nf-tag-anime{background:var(--c-anime);}
.nf-tag-manga{background:var(--c-manga);}
.nf-card-status{position:absolute;bottom:36px;left:8px;font-size:7px;font-weight:800;letter-spacing:0.4px;text-transform:uppercase;border-radius:5px;padding:2px 6px;z-index:2;color:#fff;}
.nf-st-ongoing{background:var(--s-ongoing);}
.nf-st-finished{background:var(--s-finished);}
.nf-st-morecoming{background:var(--s-morecoming);color:#000;}
.nf-st-abandoned{background:var(--s-abandoned);}
.nf-card-overlay{position:absolute;inset:0;opacity:0;display:flex;align-items:center;justify-content:center;transition:opacity .22s;}
.nf-play-btn{width:36px;height:36px;border-radius:50%;background:var(--white);display:flex;align-items:center;justify-content:center;}
.nf-play-btn svg{color:#000;margin-left:2px;}
.nf-card-dots{position:absolute;top:6px;right:6px;width:26px;height:26px;border-radius:50%;background:rgba(0,0,0,0.75);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:14px;color:white;cursor:pointer;opacity:0;transition:opacity .2s;z-index:6;}
.nf-card:hover .nf-card-dots{opacity:1;}

/* CARD DROPDOWN */
.c-drop{position:absolute;top:34px;right:0;background:#1c1c1c;border:1px solid rgba(255,255,255,0.14);border-radius:14px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.9);z-index:200;min-width:130px;animation:dropIn .15s ease;}
@keyframes dropIn{from{opacity:0;transform:scale(0.92) translateY(-6px);}to{opacity:1;transform:scale(1) translateY(0);}}
.c-drop div{padding:11px 16px;font-size:13px;cursor:pointer;color:var(--text);transition:background .1s;}
.c-drop div:hover{background:rgba(255,255,255,0.07);}
.c-drop div.danger{color:#ff5252;}

/* GENERIC */
button{background:var(--red);border:none;padding:12px 16px;border-radius:12px;color:var(--white);font-family:var(--font);font-size:14px;font-weight:600;cursor:pointer;width:100%;transition:background .15s,transform .1s;}
button:hover{background:var(--red2);}
button:active{transform:scale(0.97);}
button.secondary{background:rgba(255,255,255,0.1);color:var(--text);border:1px solid rgba(255,255,255,0.18);}
button.secondary:hover{background:rgba(255,255,255,0.18);}
input,select,textarea{padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.07);color:var(--white);font-family:var(--font);font-size:14px;width:100%;outline:none;transition:border-color .15s,background .15s;}
input:focus,select:focus,textarea:focus{border-color:rgba(255,255,255,0.4);background:rgba(255,255,255,0.1);}
input::placeholder,textarea::placeholder{color:var(--muted);}
select option{background:#1c1c1c;color:var(--text);}
textarea{resize:vertical;min-height:80px;line-height:1.5;}
.hidden{display:none!important;}

/* PAGE HEADER */
.nf-page-header{display:flex;align-items:center;gap:12px;padding:0 16px;height:56px;background:rgba(0,0,0,0.97);backdrop-filter:blur(12px);position:sticky;top:0;z-index:50;border-bottom:1px solid rgba(255,255,255,0.06);}
.nf-back-btn{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);color:var(--text);cursor:pointer;flex-shrink:0;font-size:18px;transition:background .15s;}
.nf-back-btn:hover{background:rgba(255,255,255,0.16);}
.nf-page-title{font-family:var(--font-d);font-size:22px;letter-spacing:2px;color:var(--white);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* ADD PAGE */
.add-body{max-width:500px;margin:0 auto;padding:24px 16px 90px;display:flex;flex-direction:column;gap:28px;}
.add-field-label{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;display:block;}
.add-title-input{font-family:var(--font-d);font-size:28px;letter-spacing:1px;background:transparent;border:none;border-bottom:2px solid rgba(255,255,255,0.15);border-radius:0;color:var(--white);padding:6px 2px;width:100%;outline:none;transition:border-color .2s;}
.add-title-input:focus{border-bottom-color:var(--red);}
.add-title-input::placeholder{color:rgba(255,255,255,0.2);}
.type-pills{display:flex;flex-wrap:wrap;gap:8px;}
.type-pill{padding:9px 20px;border-radius:20px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:rgba(255,255,255,0.55);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;user-select:none;}
.type-pill:hover{border-color:rgba(255,255,255,0.4);color:var(--white);}
.type-pill.sel{background:var(--red);color:var(--white);border-color:var(--red);}
.status-pills{display:flex;flex-wrap:wrap;gap:8px;}
.status-pill{padding:9px 16px;border-radius:20px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:rgba(255,255,255,0.55);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;user-select:none;white-space:nowrap;}
.status-pill:hover{border-color:rgba(255,255,255,0.4);color:var(--white);}
.status-pill.sel[data-status="ongoing"]{background:var(--s-ongoing);color:#fff;border-color:var(--s-ongoing);}
.status-pill.sel[data-status="finished"]{background:var(--s-finished);color:#fff;border-color:var(--s-finished);}
.status-pill.sel[data-status="morecoming"]{background:var(--s-morecoming);color:#000;border-color:var(--s-morecoming);}
.status-pill.sel[data-status="abandoned"]{background:var(--s-abandoned);color:#fff;border-color:var(--s-abandoned);}
.poster-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:12px;}
.poster-preview-wrap{display:none;position:relative;}
.poster-preview-wrap.show{display:block;}
.poster-preview-wrap img{width:100%;max-height:240px;object-fit:cover;border-radius:10px;display:block;}
.poster-clear-btn{position:absolute;top:7px;right:7px;width:26px;height:26px;border-radius:50%;background:rgba(0,0,0,0.78);border:1px solid rgba(255,255,255,0.2);color:white;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;}
.poster-or{text-align:center;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.upload-btn{background:transparent;border:1px dashed rgba(255,255,255,0.2);color:var(--muted);font-size:13px;font-weight:500;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border-radius:10px;transition:border-color .15s,color .15s,background .15s;box-shadow:none;}
.upload-btn:hover{border-color:rgba(255,255,255,0.4);color:var(--white);background:rgba(255,255,255,0.04);}
.add-save-btn{font-size:15px;font-weight:700;padding:15px;box-shadow:0 4px 24px rgba(229,9,20,0.35);}
.form-sep{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;}
.form-sep::before,.form-sep::after{content:'';flex:1;height:1px;background:rgba(255,255,255,0.08);}

/* DETAIL HERO — parallax */
.detail-hero{position:relative;width:100%;height:70vw;max-height:360px;min-height:240px;overflow:hidden;}
.detail-bg{position:absolute;inset:-10%;background-size:cover;background-position:center 20%;filter:brightness(0.3) blur(3px);will-change:transform;}
.detail-vignette{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,0.05) 0%,rgba(0,0,0,0.3) 40%,rgba(0,0,0,0.98) 100%);}
.detail-hero-content{position:absolute;bottom:0;left:0;right:0;padding:0 16px 20px;display:flex;align-items:flex-end;gap:14px;}
.detail-thumb{width:80px;flex-shrink:0;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.9);border:1px solid rgba(255,255,255,0.08);transition:transform .3s;}
.detail-meta{flex:1;min-width:0;}
.detail-title{font-family:var(--font-d);font-size:30px;letter-spacing:1.5px;color:var(--white);line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:8px;text-shadow:0 2px 12px rgba(0,0,0,0.8);}
.detail-badges{display:flex;align-items:center;gap:7px;flex-wrap:wrap;}
.detail-type-badge{color:var(--white);font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;border-radius:8px;padding:3px 10px;}
.detail-type-badge.type-movie{background:var(--c-movie);}
.detail-type-badge.type-series{background:var(--c-series);}
.detail-type-badge.type-anime{background:var(--c-anime);}
.detail-type-badge.type-manga{background:var(--c-manga);}
.detail-status-pill{font-size:9px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;border-radius:8px;padding:3px 10px;color:#fff;}
.detail-status-pill.s-ongoing{background:var(--s-ongoing);}
.detail-status-pill.s-finished{background:var(--s-finished);}
.detail-status-pill.s-morecoming{background:var(--s-morecoming);color:#000;}
.detail-status-pill.s-abandoned{background:var(--s-abandoned);}
.hero-edit-btn{position:absolute;top:12px;right:12px;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,0.18);border-radius:20px;padding:6px 12px;font-size:11px;color:rgba(255,255,255,0.8);cursor:pointer;font-family:var(--font);font-weight:600;width:auto;transition:background .15s;}
.hero-edit-btn:hover{background:rgba(0,0,0,0.95);color:var(--white);}
.detail-body{padding:0 16px;max-width:520px;margin:0 auto;}
.d-label{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin:20px 0 10px;}
.edit-panel{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:16px;margin:16px 0;display:flex;flex-direction:column;gap:12px;}
.edit-two{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.status-changer{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:16px;margin:16px 0;}
.notes-box{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:16px;margin:16px 0;}
.notes-save-row{display:flex;justify-content:flex-end;margin-top:10px;}
.notes-save-btn{width:auto;padding:8px 20px;font-size:13px;border-radius:10px;}
.progress-box{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:18px;margin:16px 0;}
.progress-two{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}

/* EPISODE PILLS */
.season-block{margin-bottom:10px;border:1px solid rgba(255,255,255,0.07);border-radius:14px;overflow:hidden;}
.season-head{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;cursor:pointer;background:rgba(255,255,255,0.04);user-select:none;transition:background .15s;}
.season-head:hover{background:rgba(255,255,255,0.07);}
.season-head-left{display:flex;align-items:center;gap:10px;font-size:13px;font-weight:600;color:var(--white);}
.season-ep-count{font-size:11px;color:var(--muted);font-weight:400;}
.season-chev{font-size:9px;color:var(--muted);transition:transform .2s;}
.season-chev.open{transform:rotate(180deg);}
.season-body{display:none;padding:12px 14px 14px;}
.season-body.open{display:block;}
.ep-pills-row{display:flex;flex-wrap:wrap;gap:6px;}
.ep-pill{position:relative;width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;cursor:pointer;user-select:none;flex-shrink:0;background:rgba(229,9,20,0.85);color:#fff;animation:pillPop .25s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes pillPop{from{transform:scale(0);opacity:0;}to{transform:scale(1);opacity:1;}}
.ep-pill:active{transform:scale(0.9);}
.ep-pill .tip{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1c1c1c;border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:6px 10px;white-space:nowrap;font-size:11px;font-weight:500;color:var(--white);pointer-events:none;opacity:0;transition:opacity .15s;z-index:50;box-shadow:0 4px 16px rgba(0,0,0,0.8);}
.ep-pill .tip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#1c1c1c;}
.ep-pill:hover .tip{opacity:1;}
.ep-del{position:absolute;top:-5px;right:-5px;width:15px;height:15px;border-radius:50%;background:#ff5252;color:#fff;font-size:10px;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:10;}
.ep-pill:hover .ep-del{display:flex;}
.done-row{background:rgba(229,9,20,0.07);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:10px;margin-top:8px;border:1px solid rgba(229,9,20,0.18);}
.done-row .dr-icon{color:var(--red);font-size:13px;}
.done-row .dr-text{flex:1;font-size:13px;font-weight:600;color:var(--red);}
.done-row .dr-time{font-size:11px;color:var(--muted);}
.done-row .dr-del{cursor:pointer;color:var(--muted);font-size:16px;padding:2px 5px;border-radius:5px;transition:background .15s,color .15s;}
.done-row .dr-del:hover{background:rgba(255,75,75,0.15);color:#ff5252;}

/* STATS */
.stats-body{max-width:500px;margin:0 auto;padding:20px 16px 90px;}
.stats-hero{text-align:center;padding:32px 0 28px;border-bottom:1px solid rgba(255,255,255,0.07);margin-bottom:20px;}
.stats-big{font-family:var(--font-d);font-size:88px;line-height:1;color:var(--white);letter-spacing:2px;}
.stats-sub{font-size:11px;color:var(--muted);font-weight:600;letter-spacing:2.5px;text-transform:uppercase;margin-top:4px;}
.stats-sec{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin:22px 0 10px;}
.stat-grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.stat-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:14px;padding:14px 16px;}
.stat-n{font-family:var(--font-d);font-size:38px;color:var(--white);line-height:1;letter-spacing:1px;}
.stat-l{font-size:11px;color:var(--muted);font-weight:600;margin-top:3px;}
.stat-bar-wrap{height:3px;background:rgba(255,255,255,0.08);border-radius:2px;margin-top:10px;overflow:hidden;}
.stat-bar{height:100%;border-radius:2px;width:0;transition:width .7s cubic-bezier(0.34,1.2,0.64,1);}
.type-rows{display:flex;flex-direction:column;gap:8px;}
.type-row{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:12px 14px;}
.type-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.type-n{font-size:13px;font-weight:600;color:var(--white);flex-shrink:0;width:52px;}
.type-bar-wrap{flex:1;height:5px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;}
.type-bar{height:100%;border-radius:3px;width:0;transition:width .7s cubic-bezier(0.34,1.2,0.64,1);}
.type-cnt{font-family:var(--font-d);font-size:22px;color:var(--white);letter-spacing:1px;flex-shrink:0;min-width:28px;text-align:right;}
.recent-list{display:flex;flex-direction:column;gap:6px;}
.recent-item{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:10px 14px;cursor:pointer;transition:background .15s;}
.recent-item:hover{background:rgba(255,255,255,0.07);}
.recent-thumb{width:36px;height:54px;object-fit:cover;border-radius:6px;flex-shrink:0;}
.recent-ph{width:36px;height:54px;border-radius:6px;background:#1c1c1c;flex-shrink:0;}
.recent-info{flex:1;min-width:0;}
.recent-name{font-size:13px;font-weight:600;color:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.recent-meta{font-size:11px;color:var(--muted);margin-top:2px;}
.recent-badge{font-size:8px;font-weight:800;letter-spacing:0.5px;text-transform:uppercase;border-radius:5px;padding:2px 7px;color:#fff;flex-shrink:0;}

/* TOAST */
.nf-toast{position:fixed;bottom:calc(var(--nav-h) + 12px);left:50%;transform:translateX(-50%) translateY(20px);background:#1c1c1c;border:1px solid rgba(255,255,255,0.1);color:var(--white);padding:10px 20px;border-radius:30px;font-size:13px;font-weight:500;z-index:500;transition:transform .3s cubic-bezier(0.34,1.56,0.64,1),opacity .3s;white-space:nowrap;pointer-events:none;opacity:0;box-shadow:0 4px 20px rgba(0,0,0,0.7);display:flex;align-items:center;gap:8px;}
.nf-toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.nf-toast-icon{font-size:15px;}
.detail-bottom-pad{height:90px;}

/* SKELETON */
.skel{background:linear-gradient(90deg,rgba(255,255,255,0.05) 25%,rgba(255,255,255,0.1) 50%,rgba(255,255,255,0.05) 75%);background-size:200% 100%;animation:shimmer 1.4s infinite;}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.skel-card{aspect-ratio:2/3;border-radius:12px;}

/* SWIPE HINT */
.swipe-hint{position:fixed;top:50%;left:16px;transform:translateY(-50%);width:4px;height:60px;border-radius:2px;background:rgba(255,255,255,0.15);opacity:0;transition:opacity .3s;pointer-events:none;z-index:300;}
.swipe-hint.show{opacity:1;}
</style>
</head>
<body>

<input type="file" id="importFile" hidden accept=".json">
<input type="file" id="addPosterFile" hidden accept="image/*">
<div class="nf-toast" id="toast"><span class="nf-toast-icon" id="toastIcon"></span><span id="toastMsg"></span></div>
<div class="swipe-hint" id="swipeHint"></div>

<!-- HOME PAGE -->
<div class="page page-home" id="home">
  <header class="nf-header">
    <div class="nf-logo">TRACKR</div>
    <div class="nf-header-right">
      <div class="nf-icon-btn" id="exportBtn" title="Export">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </div>
      <div class="nf-icon-btn" id="importBtn" title="Import">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      </div>
      <div class="nf-hdiv"></div>
      <div class="nf-icon-btn" id="installBtn" title="Install" style="display:none;">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </div>
      <div class="nf-icon-btn del" id="clearBtn" title="Clear All">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
      </div>
    </div>
  </header>
  <div class="nf-controls">
    <div class="nf-search-row">
      <div class="nf-search-wrap">
        <svg class="si" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input id="searchInput" placeholder="Search titles..." autocomplete="off">
      </div>
      <div class="sort-wrap">
        <div class="sort-btn" id="sortBtn">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="21" y1="10" x2="7" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="7" y2="18"/></svg>
          <span class="sort-val" id="sortLabel">Recent</span>
        </div>
        <div class="sort-drop" id="sortDrop">
          <div class="sort-opt sel" data-sort="lastEntry">Last Entry</div>
          <div class="sort-opt" data-sort="alpha">A &#8594; Z</div>
          <div class="sort-opt" data-sort="oldest">Oldest First</div>
        </div>
      </div>
    </div>
    <div class="nf-chips" id="filterRow">
      <div class="nf-chip active" data-type="all">All</div>
      <div class="nf-chip" data-type="movie">Movies</div>
      <div class="nf-chip" data-type="series">Series</div>
      <div class="nf-chip" data-type="anime">Anime</div>
      <div class="nf-chip" data-type="manga">Manga</div>
    </div>
  </div>
  <div class="nf-tabs">
    <div class="nf-tab active" data-tab="ongoing">Ongoing <span class="nf-tab-badge" id="cntOngoing">0</span></div>
    <div class="nf-tab" data-tab="finished">Finished <span class="nf-tab-badge" id="cntFinished">0</span></div>
    <div class="nf-tab" data-tab="morecoming">More Coming <span class="nf-tab-badge" id="cntMorecoming">0</span></div>
    <div class="nf-tab" data-tab="abandoned">Abandoned <span class="nf-tab-badge" id="cntAbandoned">0</span></div>
  </div>
  <div class="nf-grid" id="grid"></div>
</div>

<!-- ADD PAGE -->
<div class="page page-secondary" id="addPage">
  <div class="nf-page-header">
    <div class="nf-back-btn ripple-host" id="backFromAdd">&#8592;</div>
    <div class="nf-page-title">NEW TITLE</div>
  </div>
  <div class="add-body">
    <div><span class="add-field-label">Title</span><input class="add-title-input" id="name" placeholder="What are you watching?" autocomplete="off"></div>
    <div>
      <span class="add-field-label">Type</span>
      <div class="type-pills" id="typePills">
        <div class="type-pill sel" data-type="movie">Movie</div>
        <div class="type-pill" data-type="series">Series</div>
        <div class="type-pill" data-type="anime">Anime</div>
        <div class="type-pill" data-type="manga">Manga</div>
      </div>
    </div>
    <div>
      <span class="add-field-label">Status</span>
      <div class="status-pills" id="addStatusPills">
        <div class="status-pill sel" data-status="ongoing">Ongoing</div>
        <div class="status-pill" data-status="finished">Finished</div>
        <div class="status-pill" data-status="morecoming">More Coming</div>
        <div class="status-pill" data-status="abandoned">Abandoned</div>
      </div>
    </div>
    <div>
      <span class="add-field-label">Poster</span>
      <div class="poster-card">
        <div class="poster-preview-wrap" id="addPreviewWrap"><img id="addPreviewImg" alt=""><button class="poster-clear-btn" id="addClearImg">&#215;</button></div>
        <input id="posterUrl" placeholder="Paste image URL...">
        <div class="poster-or">or</div>
        <button class="upload-btn" id="addUploadBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          Upload from device
        </button>
      </div>
    </div>
    <button class="add-save-btn" id="saveContentBtn">Add to My List</button>
  </div>
</div>

<!-- DETAIL PAGE -->
<div class="page page-secondary" id="detail">
  <div class="nf-page-header">
    <div class="nf-back-btn ripple-host" id="backFromDetail">&#8592;</div>
    <div class="nf-page-title" id="detailName"></div>
  </div>
  <div class="detail-hero" id="detailHero">
    <div class="detail-bg" id="detailBg"></div>
    <div class="detail-vignette"></div>
    <div class="detail-hero-content">
      <img class="detail-thumb" id="detailPoster" alt="">
      <div class="detail-meta">
        <div class="detail-title" id="detailTitle"></div>
        <div class="detail-badges">
          <span class="detail-type-badge" id="detailBadge"></span>
          <span class="detail-status-pill" id="detailStatusPill"></span>
        </div>
      </div>
    </div>
    <button class="hero-edit-btn" id="editToggleBtn">Edit</button>
  </div>
  <div class="detail-body" id="detailScrollBody">
    <div class="edit-panel hidden" id="editPanel">
      <div style="font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted)">Edit Details</div>
      <input id="editName" placeholder="Title">
      <select id="editType"><option value="movie">Movie</option><option value="series">Series</option><option value="anime">Anime</option><option value="manga">Manga</option></select>
      <input id="editPosterUrl" placeholder="Poster URL">
      <div class="form-sep">or upload new image</div>
      <input id="editPosterFile" type="file" accept="image/*">
      <div class="edit-two"><button class="secondary" id="editCancelBtn">Cancel</button><button id="editSaveBtn">Save</button></div>
    </div>
    <div class="status-changer">
      <div class="d-label" style="margin-top:0">Status</div>
      <div class="status-pills" id="detailStatusPills">
        <div class="status-pill" data-status="ongoing">Ongoing</div>
        <div class="status-pill" data-status="finished">Finished</div>
        <div class="status-pill" data-status="morecoming">More Coming</div>
        <div class="status-pill" data-status="abandoned">Abandoned</div>
      </div>
    </div>
    <div class="notes-box">
      <div class="d-label" style="margin-top:0">Notes</div>
      <textarea id="notesInput" placeholder="Where you left off, thoughts, reminders..."></textarea>
      <div class="notes-save-row"><button class="notes-save-btn" id="saveNotesBtn">Save Note</button></div>
    </div>
    <div id="progressSection" class="progress-box">
      <div style="font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:14px">Log Progress</div>
      <div class="progress-two">
        <input id="seasonInput" type="number" min="1" placeholder="Season">
        <input id="episodeInput" type="number" min="1" placeholder="Episode">
      </div>
      <button id="saveProgressBtn">Save Progress</button>
    </div>
    <div class="d-label">Watch History</div>
    <div id="historyList"></div>
    <div class="detail-bottom-pad"></div>
  </div>
</div>

<!-- STATS PAGE -->
<div class="page page-secondary" id="statsPage">
  <div class="nf-page-header">
    <div class="nf-back-btn ripple-host" id="backFromStats">&#8592;</div>
    <div class="nf-page-title">MY STATS</div>
  </div>
  <div class="stats-body">
    <div class="stats-hero">
      <div class="stats-big" id="statTotal">0</div>
      <div class="stats-sub">Total Tracked</div>
    </div>
    <div class="stats-sec">By Status</div>
    <div class="stat-grid2">
      <div class="stat-card"><div class="stat-n" id="statOngoing">0</div><div class="stat-l">Ongoing</div><div class="stat-bar-wrap"><div class="stat-bar" id="barOngoing" style="background:var(--s-ongoing)"></div></div></div>
      <div class="stat-card"><div class="stat-n" id="statFinished">0</div><div class="stat-l">Finished</div><div class="stat-bar-wrap"><div class="stat-bar" id="barFinished" style="background:var(--s-finished)"></div></div></div>
      <div class="stat-card"><div class="stat-n" id="statMorecoming">0</div><div class="stat-l">More Coming</div><div class="stat-bar-wrap"><div class="stat-bar" id="barMorecoming" style="background:var(--s-morecoming)"></div></div></div>
      <div class="stat-card"><div class="stat-n" id="statAbandoned">0</div><div class="stat-l">Abandoned</div><div class="stat-bar-wrap"><div class="stat-bar" id="barAbandoned" style="background:var(--s-abandoned)"></div></div></div>
    </div>
    <div class="stats-sec">By Type</div>
    <div class="type-rows" id="typeRows"></div>
    <div class="stats-sec">Episodes &amp; Seasons</div>
    <div class="stat-grid2">
      <div class="stat-card"><div class="stat-n" id="statEps">0</div><div class="stat-l">Episodes Logged</div></div>
      <div class="stat-card"><div class="stat-n" id="statSeasons">0</div><div class="stat-l">Seasons Logged</div></div>
    </div>
    <div class="stats-sec">Recently Active</div>
    <div class="recent-list" id="recentList"></div>
    <div style="height:40px"></div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bot-nav" id="botNav">
  <div class="bot-nav-item active" id="navHome" data-nav="home">
    <div class="bot-nav-pip"></div>
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    <span class="bot-nav-label">Home</span>
  </div>
  <div class="bot-nav-item" id="navAdd" data-nav="add">
    <div class="bot-add">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </div>
  </div>
  <div class="bot-nav-item" id="navStats" data-nav="stats">
    <div class="bot-nav-pip"></div>
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
    <span class="bot-nav-label">Stats</span>
  </div>
</nav>

<script>
/* STATE */
let db=null,current=null,activeDrop=null;
let activeTab="ongoing",activeType="all",activeSort="lastEntry",searchQ="";
let addPosterData="";
const _cache={};
const PH="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='300'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%231a1a2e'/%3E%3Cstop offset='1' stop-color='%2316213e'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect fill='url(%23g)' width='200' height='300'/%3E%3Ctext x='50%25' y='42%25' font-size='48' text-anchor='middle' dy='.3em'%3E%F0%9F%8E%AC%3C/text%3E%3Ctext x='50%25' y='65%25' fill='%23555' font-size='12' text-anchor='middle' font-family='sans-serif' font-weight='bold'%3ENo Poster%3C/text%3E%3C/svg%3E";
const SLABELS={ongoing:"Ongoing",finished:"Finished",morecoming:"More Coming",abandoned:"Abandoned"};
const SCLS={ongoing:"s-ongoing",finished:"s-finished",morecoming:"s-morecoming",abandoned:"s-abandoned"};
const SCRD={ongoing:"nf-st-ongoing",finished:"nf-st-finished",morecoming:"nf-st-morecoming",abandoned:"nf-st-abandoned"};
const TCLR={movie:"var(--c-movie)",series:"var(--c-series)",anime:"var(--c-anime)",manga:"var(--c-manga)"};

/* DB */
const dbReq=indexedDB.open("TrackerDB",5);
dbReq.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains("content"))d.createObjectStore("content",{keyPath:"id",autoIncrement:true});if(!d.objectStoreNames.contains("logs"))d.createObjectStore("logs",{keyPath:"id",autoIncrement:true});};
dbReq.onsuccess=e=>{db=e.target.result;loadAll();};
dbReq.onerror=()=>toast("DB error","⚠️");
function store(n,m){return db.transaction(n,m||"readonly").objectStore(n);}
function getAll(n){return new Promise((res,rej)=>{const r=store(n).getAll();r.onsuccess=e=>res(e.target.result);r.onerror=e=>rej(e.target.error);});}

/* TOAST */
let _tt;
function toast(msg,icon){
  const el=document.getElementById("toast");
  document.getElementById("toastMsg").textContent=msg;
  document.getElementById("toastIcon").textContent=icon||"";
  el.classList.add("show");clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove("show"),2600);
}

/* RIPPLE */
function addRipple(el){
  el.addEventListener("pointerdown",e=>{
    const r=el.getBoundingClientRect(),size=Math.max(r.width,r.height)*2;
    const rip=document.createElement("span");rip.className="ripple";
    rip.style.cssText="width:"+size+"px;height:"+size+"px;left:"+(e.clientX-r.left-size/2)+"px;top:"+(e.clientY-r.top-size/2)+"px";
    el.appendChild(rip);setTimeout(()=>rip.remove(),600);
  });
}
document.querySelectorAll(".ripple-host").forEach(addRipple);

/* PAGE TRANSITIONS */
let currentPage="home";
function navigateTo(pageId,direction){
  if(pageId===currentPage)return;
  const from=document.getElementById(currentPage);
  const to=document.getElementById(pageId);
  to.classList.remove("swipe-back");
  if(pageId==="home"){
    from.classList.add("swipe-back");
    setTimeout(()=>{from.classList.remove("active","swipe-back");},320);
    to.classList.remove("hidden");
    setNavActive("home");
  } else {
    from.classList.add("hidden");
    to.classList.add("active");
    to.classList.remove("hidden");
    setNavActive(pageId);
  }
  currentPage=pageId;
  document.getElementById("botNav").style.display=(pageId==="detail"||pageId==="addPage")?"none":"flex";
}
function setNavActive(pageId){
  document.querySelectorAll(".bot-nav-item").forEach(i=>i.classList.remove("active"));
  if(pageId==="home")document.getElementById("navHome").classList.add("active");
  if(pageId==="statsPage")document.getElementById("navStats").classList.add("active");
}

/* SWIPE BACK GESTURE */
function initSwipeBack(pageEl,onBack){
  let sx=0,sy=0,dragging=false,startedFromEdge=false;
  const hint=document.getElementById("swipeHint");
  pageEl.addEventListener("touchstart",e=>{
    sx=e.touches[0].clientX;sy=e.touches[0].clientY;
    startedFromEdge=sx<40;dragging=false;
    if(startedFromEdge){hint.classList.add("show");}
  },{passive:true});
  pageEl.addEventListener("touchmove",e=>{
    if(!startedFromEdge)return;
    const dx=e.touches[0].clientX-sx,dy=e.touches[0].clientY-sy;
    if(!dragging&&Math.abs(dx)>Math.abs(dy)&&dx>0)dragging=true;
    if(dragging){
      const pct=Math.min(dx/window.innerWidth,1);
      pageEl.style.transform="translateX("+Math.max(0,dx)+"px)";
      pageEl.style.transition="none";
      document.getElementById("home").style.transform="translateX("+(-30+pct*30)+"%)";
      document.getElementById("home").style.opacity=0.7+pct*0.3;
      document.getElementById("home").style.transition="none";
    }
  },{passive:true});
  pageEl.addEventListener("touchend",e=>{
    hint.classList.remove("show");
    if(!dragging){pageEl.style.transform="";pageEl.style.transition="";return;}
    const dx=e.changedTouches[0].clientX-sx;
    pageEl.style.transform="";pageEl.style.transition="";
    document.getElementById("home").style.transform="";
    document.getElementById("home").style.opacity="";
    document.getElementById("home").style.transition="";
    dragging=false;startedFromEdge=false;
    if(dx>window.innerWidth*0.35)onBack();
  },{passive:true});
}

/* TAB SWIPE on home */
function initTabSwipe(){
  const tabs=["ongoing","finished","morecoming","abandoned"];
  const grid=document.getElementById("grid");
  let tsx=0,tsy=0,tDragging=false;
  grid.addEventListener("touchstart",e=>{tsx=e.touches[0].clientX;tsy=e.touches[0].clientY;tDragging=false;},{passive:true});
  grid.addEventListener("touchmove",e=>{
    const dx=e.touches[0].clientX-tsx,dy=e.touches[0].clientY-tsy;
    if(!tDragging&&Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>12)tDragging=true;
  },{passive:true});
  grid.addEventListener("touchend",e=>{
    if(!tDragging)return;
    const dx=e.changedTouches[0].clientX-tsx;
    if(Math.abs(dx)<50)return;
    const idx=tabs.indexOf(activeTab);
    let next=idx+(dx<0?1:-1);
    if(next<0||next>=tabs.length)return;
    activeTab=tabs[next];
    document.querySelectorAll(".nf-tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===activeTab));
    renderGrid();
  },{passive:true});
}

/* CLOSE DROPS */
function closeAll(){if(activeDrop){activeDrop.remove();activeDrop=null;}document.getElementById("sortDrop").classList.remove("open");document.getElementById("sortBtn").classList.remove("open");}
document.addEventListener("click",closeAll);

/* BOTTOM NAV */
document.getElementById("navHome").addEventListener("click",()=>goHome());
document.getElementById("navAdd").addEventListener("click",()=>showAdd());
document.getElementById("navStats").addEventListener("click",()=>showStats());

/* WIRING */
document.getElementById("exportBtn").addEventListener("click",exportData);
document.getElementById("importBtn").addEventListener("click",()=>document.getElementById("importFile").click());
document.getElementById("clearBtn").addEventListener("click",confirmClearAll);
document.getElementById("importFile").addEventListener("change",importData);
document.getElementById("backFromAdd").addEventListener("click",()=>goHome());
document.getElementById("backFromDetail").addEventListener("click",()=>goHome());
document.getElementById("backFromStats").addEventListener("click",()=>goHome());
document.getElementById("saveContentBtn").addEventListener("click",addContent);
document.getElementById("saveProgressBtn").addEventListener("click",addProgress);
document.getElementById("saveNotesBtn").addEventListener("click",saveNotes);
document.getElementById("editToggleBtn").addEventListener("click",toggleEditPanel);
document.getElementById("editCancelBtn").addEventListener("click",toggleEditPanel);
document.getElementById("editSaveBtn").addEventListener("click",saveEdit);
document.getElementById("addUploadBtn").addEventListener("click",()=>document.getElementById("addPosterFile").click());
document.getElementById("addPosterFile").addEventListener("change",e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{addPosterData=r.result;document.getElementById("posterUrl").value="";showAddPreview(r.result);};r.readAsDataURL(f);});
document.getElementById("addClearImg").addEventListener("click",()=>{addPosterData="";document.getElementById("posterUrl").value="";document.getElementById("addPosterFile").value="";document.getElementById("addPreviewWrap").classList.remove("show");});
document.getElementById("posterUrl").addEventListener("input",e=>{const v=e.target.value.trim();if(v){addPosterData="";showAddPreview(v);}else document.getElementById("addPreviewWrap").classList.remove("show");});
function showAddPreview(src){const img=document.getElementById("addPreviewImg"),w=document.getElementById("addPreviewWrap");img.src=src;img.onload=()=>w.classList.add("show");img.onerror=()=>w.classList.remove("show");}
document.getElementById("typePills").addEventListener("click",e=>{const p=e.target.closest(".type-pill");if(!p)return;document.querySelectorAll(".type-pill").forEach(x=>x.classList.remove("sel"));p.classList.add("sel");});
document.getElementById("addStatusPills").addEventListener("click",e=>{const p=e.target.closest(".status-pill");if(!p)return;document.querySelectorAll("#addStatusPills .status-pill").forEach(x=>x.classList.remove("sel"));p.classList.add("sel");});
document.getElementById("detailStatusPills").addEventListener("click",e=>{const p=e.target.closest(".status-pill");if(!p||!current)return;changeStatus(p.dataset.status);});
document.querySelectorAll(".nf-tab").forEach(t=>t.addEventListener("click",()=>{document.querySelectorAll(".nf-tab").forEach(x=>x.classList.remove("active"));t.classList.add("active");activeTab=t.dataset.tab;renderGrid();}));
document.getElementById("filterRow").addEventListener("click",e=>{const c=e.target.closest(".nf-chip[data-type]");if(!c)return;document.querySelectorAll(".nf-chip[data-type]").forEach(x=>x.classList.remove("active"));c.classList.add("active");activeType=c.dataset.type;renderGrid();});
document.getElementById("sortBtn").addEventListener("click",e=>{e.stopPropagation();const d=document.getElementById("sortDrop"),b=document.getElementById("sortBtn"),o=d.classList.contains("open");closeAll();if(!o){d.classList.add("open");b.classList.add("open");}});
document.getElementById("sortDrop").addEventListener("click",e=>{e.stopPropagation();const o=e.target.closest(".sort-opt");if(!o)return;document.querySelectorAll(".sort-opt").forEach(x=>x.classList.remove("sel"));o.classList.add("sel");activeSort=o.dataset.sort;document.getElementById("sortLabel").textContent={lastEntry:"Recent",alpha:"A\u2013Z",oldest:"Oldest"}[activeSort];closeAll();renderGrid();});
document.getElementById("searchInput").addEventListener("input",e=>{searchQ=e.target.value.trim().toLowerCase();renderGrid();});

/* PARALLAX */
document.getElementById("detail").addEventListener("scroll",()=>{
  const el=document.getElementById("detail");
  const bg=document.getElementById("detailBg");
  const scroll=el.scrollTop;
  bg.style.transform="translateY("+scroll*0.35+"px)";
},{ passive:true });

/* INIT SWIPE BACK */
initSwipeBack(document.getElementById("detail"),()=>goHome());
initSwipeBack(document.getElementById("addPage"),()=>goHome());
initSwipeBack(document.getElementById("statsPage"),()=>goHome());
initTabSwipe();

/* NAV */
function goHome(){
  navigateTo("home");
  document.getElementById("botNav").style.display="flex";
  current=null;loadAll();
}
function showAdd(){
  document.getElementById("name").value="";document.getElementById("posterUrl").value="";
  document.getElementById("addPosterFile").value="";document.getElementById("addPreviewWrap").classList.remove("show");
  addPosterData="";
  document.querySelectorAll(".type-pill").forEach(p=>p.classList.remove("sel"));
  document.querySelector(".type-pill[data-type='movie']").classList.add("sel");
  document.querySelectorAll("#addStatusPills .status-pill").forEach(p=>p.classList.remove("sel"));
  document.querySelector("#addStatusPills [data-status='ongoing']").classList.add("sel");
  navigateTo("addPage");
  setTimeout(()=>document.getElementById("name").focus(),350);
}
function showStats(){navigateTo("statsPage");renderStats();}

/* ADD CONTENT */
function addContent(){
  const name=document.getElementById("name").value.trim();
  const type=document.querySelector(".type-pill.sel")?.dataset.type||"movie";
  const status=document.querySelector("#addStatusPills .status-pill.sel")?.dataset.status||"ongoing";
  const url=document.getElementById("posterUrl").value.trim();
  if(!name){toast("Please enter a title","⚠️");return;}
  store("content","readwrite").add({name,type,poster:addPosterData||url||"",status,notes:""}).onsuccess=()=>{toast("Added to your list","✓");goHome();};
}

/* CHANGE STATUS */
function changeStatus(ns){
  if(!current)return;
  store("content","readwrite").put({...current,status:ns}).onsuccess=()=>{
    _cache[current.id].status=ns;current.status=ns;
    if(ns==="finished"){
      getAll("logs").then(logs=>{
        if(!logs.find(l=>l.contentId===current.id&&l.completed)){
          const ts=new Date().toISOString();
          store("logs","readwrite").add({contentId:current.id,completed:true,timestamp:ts}).onsuccess=()=>{
            _cache[current.id]._last=ts;current._last=ts;updateStatusUI(ns);toast("Marked Finished! 🎉","");loadHistory();
          };
        } else {updateStatusUI(ns);toast("Status updated","✓");}
      });
    } else {updateStatusUI(ns);toast("Status: "+SLABELS[ns],"✓");}
  };
}
function updateStatusUI(s){
  const p=document.getElementById("detailStatusPill");p.textContent=SLABELS[s]||s;p.className="detail-status-pill "+(SCLS[s]||"");
  document.querySelectorAll("#detailStatusPills .status-pill").forEach(x=>x.classList.toggle("sel",x.dataset.status===s));
}

/* LOAD ALL */
function loadAll(){
  if(!db)return;
  Promise.all([getAll("content"),getAll("logs")]).then(([items,logs])=>{
    Object.keys(_cache).forEach(k=>delete _cache[k]);
    items.forEach(c=>{
      const cl=logs.filter(l=>l.contentId===c.id);
      const epl=cl.filter(l=>!l.completed).sort((a,b)=>b.timestamp.localeCompare(a.timestamp));
      const times=cl.map(l=>l.timestamp).filter(Boolean).sort();
      let status=c.status||"ongoing";
      if(!c.status&&cl.some(l=>l.completed))status="finished";
      const le=epl[0];
      const lastEp=le?(c.type==="manga"?"Ch "+le.episode:"S"+(le.season||1)+" E"+le.episode):"";
      _cache[c.id]={...c,status,_last:times.length?times[times.length-1]:null,_lastEp:lastEp};
    });
    renderGrid();
  }).catch(()=>toast("Load error","⚠️"));
}

/* RENDER GRID */
function renderGrid(){
  const grid=document.getElementById("grid");grid.innerHTML="";
  const all=Object.values(_cache);
  document.getElementById("cntOngoing").textContent=all.filter(c=>c.status==="ongoing").length;
  document.getElementById("cntFinished").textContent=all.filter(c=>c.status==="finished").length;
  document.getElementById("cntMorecoming").textContent=all.filter(c=>c.status==="morecoming").length;
  document.getElementById("cntAbandoned").textContent=all.filter(c=>c.status==="abandoned").length;

  let items=all.filter(c=>c.status===activeTab);
  if(activeType!=="all")items=items.filter(c=>c.type===activeType);
  if(searchQ)items=items.filter(c=>c.name.toLowerCase().includes(searchQ));
  if(activeSort==="alpha")items.sort((a,b)=>a.name.localeCompare(b.name));
  else if(activeSort==="oldest")items.sort((a,b)=>(a._last||"").localeCompare(b._last||""));
  else items.sort((a,b)=>(b._last||"").localeCompare(a._last||""));

  if(!items.length){
    grid.innerHTML='<div class="nf-empty"><div class="nf-empty-icon">&#127916;</div><p>'+(searchQ?"No results found.":"Nothing in "+(SLABELS[activeTab]||activeTab)+" yet.")+'</p></div>';
    return;
  }
  items.forEach((c,i)=>{
    const card=document.createElement("div");card.className="nf-card ripple-host";
    card.style.animationDelay=(i*20)+"ms";
    const posterHtml=c.poster
      ?'<img src="'+esc(c.poster)+'" loading="lazy" alt="'+esc(c.name)+'">'
      :'<div class="nf-card-ph"><div class="nf-card-ph-icon">&#127916;</div><div class="nf-card-ph-name">'+esc(c.name)+'</div></div>';
    card.innerHTML=posterHtml+
      '<div class="nf-card-bottom">'+
        '<div class="nf-card-name">'+esc(c.name)+'</div>'+
        (c._lastEp?'<div class="nf-card-lastseen">'+esc(c._lastEp)+'</div>':'')+
      '</div>'+
      '<div class="nf-card-tag nf-tag-'+c.type+'">'+c.type+'</div>'+
      '<div class="nf-card-status '+(SCRD[c.status]||'')+'">'+( SLABELS[c.status]||c.status)+'</div>'+
      '<div class="nf-card-overlay"><div class="nf-play-btn"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg></div></div>'+
      '<div class="nf-card-dots">&#8942;</div>';
    addRipple(card);
    card.querySelector(".nf-play-btn").addEventListener("click",e=>{e.stopPropagation();openDetail(c);});
    card.querySelector(".nf-card-dots").addEventListener("click",ev=>{ev.stopPropagation();cardMenu(ev,c);});
    card.addEventListener("click",()=>openDetail(c));
    grid.appendChild(card);
  });
}

/* CARD MENU */
function cardMenu(ev,c){
  closeAll();const btn=ev.currentTarget;
  const drop=document.createElement("div");drop.className="c-drop";
  drop.innerHTML='<div data-a="view">View</div><div data-a="del" class="danger">Delete</div>';
  drop.querySelector("[data-a=view]").addEventListener("click",e=>{e.stopPropagation();closeAll();openDetail(c);});
  drop.querySelector("[data-a=del]").addEventListener("click",e=>{e.stopPropagation();deleteContent(c.id);});
  drop.addEventListener("click",e=>e.stopPropagation());
  btn.appendChild(drop);activeDrop=drop;
}

/* DELETE CONTENT */
function deleteContent(id){
  closeAll();if(!confirm("Remove from your list?"))return;
  store("content","readwrite").delete(id).onsuccess=()=>{
    delete _cache[id];
    getAll("logs").then(logs=>{
      const toGo=logs.filter(l=>l.contentId===id);
      if(!toGo.length){toast("Removed","🗑");renderGrid();return;}
      const tx=db.transaction("logs","readwrite"),st=tx.objectStore("logs");
      toGo.forEach(l=>st.delete(l.id));
      tx.oncomplete=()=>{toast("Removed","🗑");renderGrid();};
    });
  };
}

/* OPEN DETAIL */
function openDetail(c){
  if(!c)return;current={...c};
  const poster=c.poster||PH;
  document.getElementById("detailPoster").src=poster;
  document.getElementById("detailBg").style.backgroundImage="url("+poster+")";
  document.getElementById("detailName").textContent=c.name.toUpperCase();
  document.getElementById("detailTitle").textContent=c.name.toUpperCase();
  document.getElementById("detailBadge").textContent=c.type.toUpperCase();
  document.getElementById("detailBadge").className="detail-type-badge type-"+c.type;
  updateStatusUI(c.status||"ongoing");
  document.getElementById("notesInput").value=c.notes||"";
  document.getElementById("editPanel").classList.add("hidden");
  document.getElementById("detail").scrollTop=0;
  const ps=document.getElementById("progressSection"),si=document.getElementById("seasonInput"),ei=document.getElementById("episodeInput");
  si.value="";ei.value="";
  if(c.type==="movie")ps.style.display="none";
  else if(c.type==="manga"){ps.style.display="block";si.placeholder="Volume";ei.placeholder="Chapter";}
  else{ps.style.display="block";si.placeholder="Season";ei.placeholder="Episode";}
  navigateTo("detail");
  loadHistory();
}

/* EDIT PANEL */
function toggleEditPanel(){
  const p=document.getElementById("editPanel");
  if(p.classList.contains("hidden")){
    document.getElementById("editName").value=current.name;
    document.getElementById("editType").value=current.type;
    document.getElementById("editPosterUrl").value=(current.poster&&!current.poster.startsWith("data:"))?current.poster:"";
    document.getElementById("editPosterFile").value="";
    p.classList.remove("hidden");setTimeout(()=>document.getElementById("editName").focus(),80);
  } else p.classList.add("hidden");
}
function saveEdit(){
  const name=document.getElementById("editName").value.trim();
  const type=document.getElementById("editType").value;
  const url=document.getElementById("editPosterUrl").value.trim();
  const file=document.getElementById("editPosterFile").files[0];
  if(!name){toast("Title cannot be empty","⚠️");return;}
  const apply=poster=>{
    const upd={id:current.id,name,type,poster:poster!==undefined?poster:current.poster,status:current.status,notes:current.notes||""};
    store("content","readwrite").put(upd).onsuccess=()=>{
      _cache[upd.id]={..._cache[upd.id],...upd};current={..._cache[upd.id]};
      const p=upd.poster||PH;
      document.getElementById("detailPoster").src=p;
      document.getElementById("detailBg").style.backgroundImage="url("+p+")";
      document.getElementById("detailName").textContent=name.toUpperCase();
      document.getElementById("detailTitle").textContent=name.toUpperCase();
      document.getElementById("detailBadge").textContent=type.toUpperCase();
      document.getElementById("detailBadge").className="detail-type-badge type-"+type;
      document.getElementById("editPanel").classList.add("hidden");
      const ps=document.getElementById("progressSection"),si=document.getElementById("seasonInput"),ei=document.getElementById("episodeInput");
      if(type==="movie")ps.style.display="none";else if(type==="manga"){ps.style.display="block";si.placeholder="Volume";ei.placeholder="Chapter";}else{ps.style.display="block";si.placeholder="Season";ei.placeholder="Episode";}
      toast("Saved","✓");
    };
  };
  if(file){const r=new FileReader();r.onload=()=>apply(r.result);r.onerror=()=>toast("Could not read image","⚠️");r.readAsDataURL(file);}
  else apply(url||undefined);
}

/* NOTES */
function saveNotes(){
  if(!current)return;const notes=document.getElementById("notesInput").value;
  store("content","readwrite").put({...current,notes}).onsuccess=()=>{_cache[current.id].notes=notes;current.notes=notes;toast("Note saved","✓");};
}

/* PROGRESS */
function addProgress(){
  const season=parseInt(document.getElementById("seasonInput").value)||1;
  const episode=parseInt(document.getElementById("episodeInput").value)||1;
  getAll("logs").then(logs=>{
    if(logs.find(l=>l.contentId===current.id&&l.season===season&&l.episode===episode)){toast("Already logged","ℹ️");return;}
    const ts=new Date().toISOString();
    store("logs","readwrite").add({contentId:current.id,season,episode,timestamp:ts}).onsuccess=()=>{
      if(!_cache[current.id]._last||ts>_cache[current.id]._last){_cache[current.id]._last=ts;current._last=ts;}
      const ep=current.type==="manga"?"Ch "+episode:"S"+season+" E"+episode;
      _cache[current.id]._lastEp=ep;current._lastEp=ep;
      toast("Progress saved","✓");loadHistory();
    };
  });
}

/* HISTORY */
function loadHistory(){
  getAll("logs").then(logs=>{
    const mine=logs.filter(l=>l.contentId===current.id).sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
    const list=document.getElementById("historyList");list.innerHTML="";
    if(!mine.length){list.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:24px 0">No watch history yet</div>';return;}
    const dones=mine.filter(l=>l.completed),eps=mine.filter(l=>!l.completed);
    const isManga=current.type==="manga";
    const seasons={};
    eps.forEach(l=>{const s=l.season??1;if(!seasons[s])seasons[s]=[];seasons[s].push(l);});
    Object.keys(seasons).sort((a,b)=>Number(b)-Number(a)).forEach(s=>{
      const entries=seasons[s],lbl=isManga?"Volume "+s:"Season "+s;
      const block=document.createElement("div");block.className="season-block";
      const head=document.createElement("div");head.className="season-head";
      head.innerHTML='<div class="season-head-left"><span>'+lbl+'</span><span class="season-ep-count">'+entries.length+' '+(isManga?"ch":"ep")+(entries.length===1?"":"s")+'</span></div><span class="season-chev open">&#9660;</span>';
      const body=document.createElement("div");body.className="season-body open";
      const row=document.createElement("div");row.className="ep-pills-row";
      entries.forEach((l,i)=>{
        const pill=document.createElement("div");pill.className="ep-pill";
        pill.style.animationDelay=(i*30)+"ms";
        const lbl2=document.createElement("span");lbl2.textContent=isManga?l.episode:"E"+l.episode;
        const tip=document.createElement("div");tip.className="tip";tip.textContent=(isManga?"Ch ":"Ep ")+l.episode+" \u2022 "+fmtDate(l.timestamp);
        const del=document.createElement("div");del.className="ep-del";del.textContent="\u00d7";
        del.addEventListener("click",e=>{e.stopPropagation();deleteLog(l.id);});
        pill.appendChild(lbl2);pill.appendChild(tip);pill.appendChild(del);
        row.appendChild(pill);
      });
      body.appendChild(row);block.appendChild(head);block.appendChild(body);
      head.addEventListener("click",()=>{const o=body.classList.toggle("open");head.querySelector(".season-chev").classList.toggle("open",o);});
      list.appendChild(block);
    });
    dones.forEach(l=>{
      const row=document.createElement("div");row.className="done-row";
      row.innerHTML='<span class="dr-icon">\u2713</span><span class="dr-text">Finished</span><span class="dr-time">'+fmtDate(l.timestamp)+'</span><span class="dr-del">\u00d7</span>';
      row.querySelector(".dr-del").addEventListener("click",()=>deleteLog(l.id));
      list.appendChild(row);
    });
  });
}
function deleteLog(id){
  store("logs","readwrite").delete(id).onsuccess=()=>{
    getAll("logs").then(logs=>{
      const rem=logs.filter(l=>l.contentId===current.id);
      const times=rem.map(l=>l.timestamp).filter(Boolean).sort();
      _cache[current.id]._last=times.length?times[times.length-1]:null;current._last=_cache[current.id]._last;
      const le=rem.filter(l=>!l.completed).sort((a,b)=>b.timestamp.localeCompare(a.timestamp))[0];
      const ep=le?(current.type==="manga"?"Ch "+le.episode:"S"+(le.season||1)+" E"+le.episode):"";
      _cache[current.id]._lastEp=ep;current._lastEp=ep;
      toast("Removed","🗑");loadHistory();
    });
  };
}

/* STATS */
function renderStats(){
  const all=Object.values(_cache),total=all.length;
  document.getElementById("statTotal").textContent=total;
  const bs={ongoing:0,finished:0,morecoming:0,abandoned:0};
  const bt={movie:0,series:0,anime:0,manga:0};
  all.forEach(c=>{if(c.status in bs)bs[c.status]++;if(c.type in bt)bt[c.type]++;});
  ["ongoing","finished","morecoming","abandoned"].forEach(s=>{document.getElementById("stat"+cap(s)).textContent=bs[s];});
  setTimeout(()=>{
    ["ongoing","finished","morecoming","abandoned"].forEach(s=>{
      document.getElementById("bar"+cap(s)).style.width=(total?Math.round(bs[s]/total*100):0)+"%";
    });
  },120);
  const maxT=Math.max(...Object.values(bt),1);
  const tr=document.getElementById("typeRows");tr.innerHTML="";
  [["movie","Movies"],["series","Series"],["anime","Anime"],["manga","Manga"]].forEach(([t,label])=>{
    const cnt=bt[t],pct=Math.round(cnt/maxT*100);
    const row=document.createElement("div");row.className="type-row";
    row.innerHTML='<div class="type-dot" style="background:'+TCLR[t]+'"></div><div class="type-n">'+label+'</div><div class="type-bar-wrap"><div class="type-bar" data-pct="'+pct+'" style="background:'+TCLR[t]+'"></div></div><div class="type-cnt">'+cnt+'</div>';
    tr.appendChild(row);
  });
  setTimeout(()=>tr.querySelectorAll(".type-bar").forEach(b=>b.style.width=b.dataset.pct+"%"),120);
  getAll("logs").then(logs=>{
    const epl=logs.filter(l=>!l.completed);
    document.getElementById("statEps").textContent=epl.length;
    document.getElementById("statSeasons").textContent=new Set(epl.map(l=>l.contentId+"-"+(l.season||1))).size;
    const recent=all.filter(c=>c._last).sort((a,b)=>b._last.localeCompare(a._last)).slice(0,8);
    const rl=document.getElementById("recentList");rl.innerHTML="";
    recent.forEach(c=>{
      const item=document.createElement("div");item.className="recent-item";
      const thumb=c.poster?'<img class="recent-thumb" src="'+esc(c.poster)+'" alt="">':'<div class="recent-ph"></div>';
      item.innerHTML=thumb+'<div class="recent-info"><div class="recent-name">'+esc(c.name)+'</div><div class="recent-meta">'+(c._lastEp?esc(c._lastEp)+" \u2022 ":"")+fmtDate(c._last)+'</div></div><div class="recent-badge" style="background:'+TCLR[c.type]+'">'+c.type+'</div>';
      item.addEventListener("click",()=>{navigateTo("home");openDetail(c);});
      rl.appendChild(item);
    });
  });
}

/* EXPORT / IMPORT / CLEAR */
async function exportData(){
  try{
    const[content,logs]=await Promise.all([getAll("content"),getAll("logs")]);
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([JSON.stringify({content,logs},null,2)],{type:"application/json"}));
    a.download="trackr_backup_"+new Date().toISOString().split("T")[0]+".json";a.click();toast("Exported","✓");
  }catch{toast("Export failed","⚠️");}
}
function importData(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result);if(!data.content||!data.logs)throw 0;
      const ct=db.transaction("content","readwrite"),cs=ct.objectStore("content");
      cs.clear().onsuccess=()=>data.content.forEach(c=>cs.add(c));
      ct.oncomplete=()=>{const lt=db.transaction("logs","readwrite"),ls=lt.objectStore("logs");ls.clear().onsuccess=()=>data.logs.forEach(l=>ls.add(l));lt.oncomplete=()=>{toast("Import successful","✓");loadAll();};};
    }catch{toast("Invalid backup file","⚠️");}
    e.target.value="";
  };r.readAsText(file);
}
function confirmClearAll(){
  if(!confirm("Remove everything? This cannot be undone."))return;
  const ct=db.transaction("content","readwrite");ct.objectStore("content").clear();
  ct.oncomplete=()=>{const lt=db.transaction("logs","readwrite");lt.objectStore("logs").clear();lt.oncomplete=()=>{Object.keys(_cache).forEach(k=>delete _cache[k]);toast("Cleared","🗑");renderGrid();};};
}

/* UTILS */
function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
function fmtDate(ts){const d=new Date(ts);return d.toLocaleDateString()+" "+d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}
</script>

<script>
// PWA install prompt handling
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'flex';
});
installBtn.addEventListener('click', () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(choiceResult => {
    if (choiceResult.outcome === 'accepted') {
      console.log('User accepted the install prompt');
    } else {
      console.log('User dismissed the install prompt');
    }
    deferredPrompt = null;
    installBtn.style.display = 'none';
  });
});

window.addEventListener('appinstalled', () => {
  console.log('PWA was installed');
});

// inline service worker via blob
if('serviceWorker' in navigator){
  const swCode=`
    const CACHE='trackr-v1';
    const ASSETS=[];
    self.addEventListener('install',e=>{self.skipWaiting();});
    self.addEventListener('activate',e=>{e.waitUntil(clients.claim());});
    self.addEventListener('fetch',e=>{
      e.respondWith(
        caches.match(e.request).then(cached=>{
          return cached||fetch(e.request).then(res=>{
            const clone=res.clone();
            caches.open(CACHE).then(c=>c.put(e.request,clone));
            return res;
          }).catch(()=>cached);
        })
      );
    });
  `;
  const blob=new Blob([swCode],{type:'application/javascript'});
  const swUrl=URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl,{scope:'./'})
    .then(()=>console.log('SW ready'))
    .catch(e=>console.warn('SW failed',e));
}
</script>
</body>
</html>
