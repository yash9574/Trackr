<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Trackr</title>
<link rel="icon" href="icon.png" type="image/png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --black:#000;--bg:#0f0f0f;--surface:#1a1a1a;--surface2:#252525;
  --text:#e5e5e5;--text-secondary:#b0b0b0;--muted:rgba(255,255,255,0.45);--white:#fff;
  --red:#e50914;--red2:#b81d24;--red-glow:rgba(229,9,20,0.35);--red-light:rgba(229,9,20,0.15);
  --c-movie:#e50914;--c-series:#0080ff;--c-anime:#9b59f5;--c-manga:#ff8c00;
  --s-ongoing:#22c55e;--s-finished:#e50914;--s-morecoming:#f59e0b;--s-abandoned:#6b7280;
  --font-d:'Bebas Neue',Impact,sans-serif;--font:'Inter',sans-serif;
  --nav-h:64px;
  --shadow-sm:0 2px 8px rgba(0,0,0,0.4);
  --shadow-md:0 8px 24px rgba(0,0,0,0.5);
  --shadow-lg:0 16px 40px rgba(0,0,0,0.6);
  --shadow-xl:0 24px 60px rgba(0,0,0,0.7);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{-webkit-tap-highlight-color:transparent;}
body{background:var(--black);color:var(--text);font-family:var(--font);font-size:14px;min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;overscroll-behavior:none;background:linear-gradient(135deg,#0a0a0a 0%,#1a1a2e 100%);position:relative;width:100%;height:100vh;}

/* PAGE SYSTEM */
.page{position:fixed;inset:0;overflow-y:auto;overflow-x:hidden;background:var(--black);will-change:transform;transition:transform .32s cubic-bezier(0.4,0,0.2,1),opacity .32s;}
.page.hidden{pointer-events:none;}
.page-home{transform:translateX(0);}
.page-home.hidden{transform:translateX(-30%);opacity:0;}
.page-secondary{transform:translateX(100%);}
.page-secondary.active{transform:translateX(0);}
.page-secondary.swipe-back{transform:translateX(100%);opacity:0;}

/* RIPPLE */
.ripple-host{position:relative;overflow:hidden;}
.ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,0.18);transform:scale(0);animation:ripple-anim .5s linear;pointer-events:none;}
@keyframes ripple-anim{to{transform:scale(4);opacity:0;}}

/* BOTTOM NAV */
.bot-nav{position:fixed;bottom:0;left:0;right:0;z-index:200;height:var(--nav-h);background:linear-gradient(180deg,rgba(10,10,10,0.95),rgba(0,0,0,0.99));backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:space-around;padding-bottom:env(safe-area-inset-bottom);box-shadow:0 -2px 20px rgba(0,0,0,0.6);}
.bot-nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;padding:8px 0;cursor:pointer;color:var(--text-secondary);transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);position:relative;}
.bot-nav-item:hover{color:var(--text);}
.bot-nav-item.active{color:var(--red);}
.bot-nav-item svg{transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);filter:drop-shadow(0 0 0 transparent);}
.bot-nav-item.active svg{transform:scale(1.15);filter:drop-shadow(0 0 8px var(--red-glow));}
.bot-nav-label{font-size:10px;font-weight:600;letter-spacing:0.3px;}
.bot-nav-pip{position:absolute;top:4px;width:6px;height:6px;border-radius:50%;background:var(--red);opacity:0;transform:scale(0);transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);box-shadow:0 0 12px var(--red-glow);}
.bot-nav-item.active .bot-nav-pip{opacity:1;transform:scale(1);}
.bot-add{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--red),#ff1a1a);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 24px var(--red-glow);transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.1);}
.bot-add::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.3),transparent);opacity:0;transition:opacity .3s;}
.bot-add:hover{transform:translateY(-4px);box-shadow:0 12px 36px var(--red-glow);}
.bot-add:active{transform:scale(0.95);}
.bot-add:hover::before{opacity:1;}


/* HEADER */
.nf-header{position:sticky;top:0;z-index:100;display:flex;align-items:center;padding:0 16px;height:56px;background:linear-gradient(180deg,rgba(0,0,0,0.98),rgba(0,0,0,0.85));backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.08);box-shadow:var(--shadow-md);}
.nf-logo{font-family:var(--font-d);font-size:30px;letter-spacing:3px;color:var(--red);flex:1;text-shadow:0 2px 20px var(--red-glow);line-height:1;transition:letter-spacing .3s ease;}
.nf-logo:hover{letter-spacing:4px;}
.nf-header-right{display:flex;align-items:center;gap:12px;}
.nf-icon-btn{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);color:var(--text);cursor:pointer;flex-shrink:0;transition:all .2s cubic-bezier(0.25,0.46,0.45,0.94);position:relative;overflow:hidden;}
.nf-icon-btn::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at var(--mouse-x,50%) var(--mouse-y,50%),rgba(255,255,255,0.15),transparent);opacity:0;transition:opacity .2s;}
.nf-icon-btn:hover{background:rgba(255,255,255,0.12);border-color:rgba(255,255,255,0.25);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.3);}
.nf-icon-btn:active{transform:scale(0.95);}
.nf-icon-btn svg{transition:transform .2s,filter .2s;}
.nf-icon-btn:hover svg{transform:scale(1.05);filter:drop-shadow(0 0 4px var(--red-glow));}


/* MORE MENU */
.more-wrap{position:relative;}
.more-drop{position:absolute;top:calc(100% + 8px);right:0;background:linear-gradient(135deg,#1c1c1c,#252525);border:1px solid rgba(255,255,255,0.12);border-radius:14px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,0.9);z-index:300;min-width:160px;display:none;animation:dropIn .2s cubic-bezier(0.25,0.46,0.45,0.94);}
@keyframes dropIn{from{opacity:0;transform:translateY(-8px);} to{opacity:1;transform:translateY(0);}}
.more-drop.open{display:block;}
.more-item{padding:13px 16px;font-size:13px;cursor:pointer;color:var(--text);display:flex;align-items:center;gap:10px;transition:all .2s;position:relative;}
.more-item::before{content:'';position:absolute;inset:0;background:rgba(255,255,255,0.07);opacity:0;transition:opacity .2s;}
.more-item:hover::before{opacity:1;}
.more-item:hover{color:var(--white);}
.more-item.danger{color:#ff5252;}
.more-item.danger:hover{background:rgba(255,80,80,0.1);}
.more-item svg{flex-shrink:0;opacity:0.7;transition:opacity .2s;position:relative;z-index:1;}
.more-item:hover svg{opacity:1;}


/* AVATAR */
.avatar-btn{width:40px;height:40px;border-radius:12px;overflow:hidden;cursor:pointer;border:2px solid rgba(255,255,255,0.15);background:linear-gradient(135deg,rgba(229,9,20,0.15),rgba(255,255,255,0.07));display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--white);flex-shrink:0;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);}
.avatar-btn:hover{border-color:var(--red);box-shadow:0 0 12px var(--red-glow);transform:translateY(-2px);}
.avatar-btn img{width:100%;height:100%;object-fit:cover;}
.avatar-initials{font-family:var(--font-d);font-size:16px;letter-spacing:1px;color:var(--red);}


/* CONTROLS */
.nf-controls{position:sticky;top:56px;z-index:90;background:linear-gradient(180deg,rgba(0,0,0,0.98),rgba(0,0,0,0.9));backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,0.06);padding:12px 16px;display:flex;flex-direction:column;gap:12px;}
.nf-search-row{display:flex;gap:10px;align-items:center;}
.nf-search-wrap{position:relative;flex:1;}
.nf-search-wrap .si{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-secondary);pointer-events:none;transition:color .2s;}
#searchInput{width:100%;padding:11px 14px 11px 40px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:var(--white);font-family:var(--font);font-size:13px;outline:none;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);}
#searchInput:focus{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.35);box-shadow:0 0 20px var(--red-light);}
#searchInput:focus~.si{color:var(--red);}
#searchInput::placeholder{color:var(--muted);}
.sort-wrap{position:relative;flex-shrink:0;}
.sort-btn{display:flex;align-items:center;gap:8px;height:40px;padding:0 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:var(--text);font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;user-select:none;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);}
.sort-btn:hover,.sort-btn.open{background:rgba(255,255,255,0.12);border-color:rgba(255,255,255,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.3);}
.sort-val{color:var(--red);font-size:11px;font-weight:700;}
.sort-drop{position:absolute;top:calc(100% + 8px);right:0;background:linear-gradient(135deg,#1c1c1c,#252525);border:1px solid rgba(255,255,255,0.12);border-radius:14px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,0.9);z-index:200;min-width:168px;display:none;animation:dropIn .2s cubic-bezier(0.25,0.46,0.45,0.94);}
.sort-drop.open{display:block;}
.sort-opt{padding:12px 16px;font-size:13px;cursor:pointer;color:rgba(255,255,255,0.65);display:flex;align-items:center;justify-content:space-between;transition:all .2s;position:relative;}
.sort-opt::before{content:'';position:absolute;inset:0;background:rgba(255,255,255,0.07);opacity:0;transition:opacity .2s;}
.sort-opt:hover{background:rgba(255,255,255,0.07);color:var(--white);}
.sort-opt.sel{color:var(--white);font-weight:700;}
.sort-opt.sel::after{content:'';width:6px;height:6px;border-radius:50%;background:var(--red);box-shadow:0 0 8px var(--red-glow);}

.nf-chips{display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;padding:4px 0;}
.nf-chips::-webkit-scrollbar{display:none;}
.nf-chip{padding:7px 16px;border-radius:20px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.7);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;flex-shrink:0;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);user-select:none;position:relative;}
.nf-chip::before{content:'';position:absolute;inset:0;border-radius:20px;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.1),transparent);opacity:0;transition:opacity .3s;}
.nf-chip:hover{border-color:rgba(255,255,255,0.4);background:rgba(255,255,255,0.1);color:var(--white);box-shadow:0 0 12px rgba(255,255,255,0.1);}
.nf-chip:hover::before{opacity:1;}
.nf-chip.active{background:var(--red);color:var(--white);border-color:var(--red);font-weight:700;box-shadow:0 0 16px var(--red-glow);}


/* TABS */
.nf-tabs{display:flex;padding:0 4px;background:linear-gradient(180deg,rgba(0,0,0,0.92),rgba(0,0,0,0.88));backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,0.07);position:sticky;top:160px;z-index:89;overflow-x:auto;overflow-y:hidden;scrollbar-width:thin;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;}
.nf-tabs::-webkit-scrollbar{height:3px;}
.nf-tabs::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);}
.nf-tabs::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:3px;}
.nf-tabs::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.25);}
.nf-tab{padding:14px 20px;font-size:13px;font-weight:700;letter-spacing:0.3px;color:var(--text-secondary);cursor:pointer;border-bottom:3px solid transparent;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);user-select:none;white-space:nowrap;flex-shrink:0;position:relative;}
.nf-tab:hover{color:var(--text);}
.nf-tab.active{color:var(--white);border-bottom-color:var(--red);}
.nf-tab-badge{display:inline-flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.1);border-radius:6px;font-size:10px;padding:2px 6px;margin-left:8px;font-weight:700;color:var(--text-secondary);vertical-align:middle;transition:all .2s;}
.nf-tab:hover .nf-tab-badge{background:rgba(255,255,255,0.15);color:var(--text);}
.nf-tab.active .nf-tab-badge{background:rgba(229,9,20,0.25);color:var(--red);}


/* GRID */
.nf-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:16px 16px 100px;}
.nf-empty{grid-column:1/-1;text-align:center;padding:80px 32px;color:var(--text-secondary);}
.nf-empty-icon{font-size:56px;opacity:0.3;margin-bottom:20px;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);} 50%{transform:translateY(-8px);}}
.nf-empty p{font-size:15px;line-height:1.7;color:var(--text-secondary);}


/* CARD */
.nf-card{position:relative;cursor:pointer;aspect-ratio:2/3;background:#1c1c1c;border-radius:14px;overflow:hidden;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);box-shadow:var(--shadow-lg);border:1px solid rgba(255,255,255,0.06);display:flex;flex-direction:column;}
.nf-card:hover{transform:translateY(-8px);box-shadow:var(--shadow-xl);border-color:rgba(255,255,255,0.12);}
.nf-card:active{transform:scale(0.98);}
.nf-card img{width:100%;height:100%;object-fit:cover;display:block;transition:filter .3s cubic-bezier(0.25,0.46,0.45,0.94);filter:brightness(1);}
.nf-card:hover img{filter:brightness(1.15) saturate(1.1);}
.nf-card::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(229,9,20,0.15),transparent);opacity:0;transition:opacity .3s;pointer-events:none;border-radius:14px;}
.nf-card:hover::after{opacity:1;}
.nf-card .nf-card-info{display:none;}
.nf-card-overlay-name{position:absolute;bottom:0;left:0;right:0;padding:16px;background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,0.95));backdrop-filter:blur(8px);display:flex;align-items:flex-end;min-height:70px;z-index:3;}
.nf-card-overlay-name .nf-card-text{flex:1;}
.nf-card-overlay-name .nf-card-title{font-size:13px;font-weight:700;color:var(--white);line-height:1.2;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.nf-card-overlay-name .nf-card-type{font-size:9px;color:var(--text-secondary);font-weight:600;margin-top:4px;text-transform:uppercase;letter-spacing:0.5px;}
.nf-card-ph{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:12px;background:linear-gradient(145deg,#1a1a2e,#16213e);}
.nf-card-ph-icon{font-size:28px;opacity:0.4;}
.nf-card-ph-name{font-size:10px;font-weight:700;color:rgba(255,255,255,0.4);text-align:center;line-height:1.3;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.nf-card-bottom{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,0.97) 0%,rgba(0,0,0,0.7) 50%,transparent 100%);padding:24px 8px 8px;}
.nf-card-name{font-size:10px;font-weight:700;color:#fff;line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-shadow:0 1px 4px rgba(0,0,0,0.9);}
.nf-card-lastseen{font-size:9px;color:rgba(255,255,255,0.5);margin-top:2px;font-weight:500;}
.nf-card-tag{position:absolute;top:6px;left:6px;font-size:8px;font-weight:800;letter-spacing:0.5px;text-transform:uppercase;border-radius:6px;padding:3px 7px;z-index:2;color:#fff;}
.nf-tag-movie{background:var(--c-movie);}
.nf-tag-series{background:var(--c-series);}
.nf-tag-anime{background:var(--c-anime);}
.nf-tag-manga{background:var(--c-manga);}
.nf-card-status{position:absolute;bottom:36px;left:8px;font-size:7px;font-weight:800;letter-spacing:0.4px;text-transform:uppercase;border-radius:5px;padding:2px 6px;z-index:2;color:#fff;}
.nf-st-ongoing{background:var(--s-ongoing);}
.nf-st-finished{background:var(--s-finished);}
.nf-st-morecoming{background:var(--s-morecoming);color:#000;}
.nf-st-abandoned{background:var(--s-abandoned);}
.nf-card-overlay{position:absolute;inset:0;opacity:0;display:flex;align-items:center;justify-content:center;transition:opacity .22s;}
.nf-play-btn{width:36px;height:36px;border-radius:50%;background:var(--white);display:flex;align-items:center;justify-content:center;}
.nf-play-btn svg{color:#000;margin-left:2px;}
.nf-card-dots{position:absolute;top:6px;right:6px;width:26px;height:26px;border-radius:50%;background:rgba(0,0,0,0.75);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:14px;color:white;cursor:pointer;opacity:0;transition:opacity .2s;z-index:6;}
.nf-card:hover .nf-card-dots{opacity:1;}

/* CARD DROPDOWN */
.c-drop{position:absolute;top:34px;right:0;background:#1c1c1c;border:1px solid rgba(255,255,255,0.14);border-radius:14px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.9);z-index:200;min-width:130px;animation:dropIn .15s ease;}
@keyframes dropIn{from{opacity:0;transform:scale(0.92) translateY(-6px);}to{opacity:1;transform:scale(1) translateY(0);}}
.c-drop div{padding:11px 16px;font-size:13px;cursor:pointer;color:var(--text);transition:background .1s;}
.c-drop div:hover{background:rgba(255,255,255,0.07);}
.c-drop div.danger{color:#ff5252;}

/* GENERIC */
button{background:var(--red);border:none;padding:12px 16px;border-radius:12px;color:var(--white);font-family:var(--font);font-size:14px;font-weight:600;cursor:pointer;width:100%;transition:background .15s,transform .1s;}
button:hover{background:var(--red2);}
button:active{transform:scale(0.97);}
button.secondary{background:rgba(255,255,255,0.1);color:var(--text);border:1px solid rgba(255,255,255,0.18);}
button.secondary:hover{background:rgba(255,255,255,0.18);}
input,select,textarea{padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:var(--white);font-family:var(--font);font-size:14px;width:100%;outline:none;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);}
input:focus,select:focus,textarea:focus{border-color:rgba(255,255,255,0.35);background:rgba(255,255,255,0.1);box-shadow:0 0 20px var(--red-light);}
input::placeholder,textarea::placeholder{color:var(--muted);}
select option{background:#1c1c1c;color:var(--text);}
textarea{resize:vertical;min-height:100px;line-height:1.5;}
.hidden{display:none!important;}

/* BUTTONS */
button{font-weight:700;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);border:none;cursor:pointer;border-radius:12px;}
button:active{transform:scale(0.98);}


/* PAGE HEADER */
.nf-page-header{display:flex;align-items:center;gap:14px;padding:0 16px;height:56px;background:linear-gradient(180deg,rgba(0,0,0,0.97),rgba(0,0,0,0.88));backdrop-filter:blur(12px);position:sticky;top:0;z-index:50;border-bottom:1px solid rgba(255,255,255,0.06);box-shadow:var(--shadow-md);}
.nf-back-btn{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);color:var(--text);cursor:pointer;flex-shrink:0;font-size:18px;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);}
.nf-back-btn:hover{background:rgba(255,255,255,0.12);border-color:rgba(255,255,255,0.25);transform:translateX(-2px);}
.nf-back-btn:active{transform:scale(0.95);}
.nf-page-title{font-family:var(--font-d);font-size:24px;letter-spacing:1px;color:var(--white);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-shadow:0 2px 8px rgba(0,0,0,0.3);}


/* LOGIN PAGE */
.login-wrap{position:fixed;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;background:linear-gradient(135deg,rgba(0,0,0,0.95) 0%,rgba(26,26,46,0.95) 100%);overflow-y:auto;z-index:1000;}
.login-logo{font-family:var(--font-d);font-size:80px;letter-spacing:8px;color:var(--red);text-shadow:0 8px 40px var(--red-glow),0 0 20px var(--red);margin-bottom:12px;animation:fadeInScale .6s ease-out;text-align:center;}
@keyframes fadeInScale{from{opacity:0;transform:scale(0.9);} to{opacity:1;transform:scale(1);}}
.login-sub{font-size:13px;color:var(--text-secondary);letter-spacing:2px;text-transform:uppercase;margin-bottom:56px;opacity:0;animation:fadeInScale .6s .2s ease-out forwards;text-align:center;}
.login-card{width:100%;max-width:420px;background:rgba(28,28,28,0.6);backdrop-filter:blur(30px);border:1.5px solid rgba(255,255,255,0.15);border-radius:24px;padding:40px 36px;display:flex;flex-direction:column;gap:20px;box-shadow:0 20px 60px rgba(0,0,0,0.8),inset 0 1px 0 rgba(255,255,255,0.1);opacity:0;animation:fadeInScale .6s .3s ease-out forwards;position:relative;overflow:hidden;}
.login-card::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 100% 0,rgba(255,255,255,0.05),transparent);pointer-events:none;}
.login-card > *{position:relative;z-index:1;}
.login-title{font-size:20px;font-weight:700;color:var(--white);margin-bottom:8px;text-align:center;}
.login-toggle{font-size:13px;color:var(--text-secondary);text-align:center;margin-top:8px;}
.login-toggle span{color:var(--red);cursor:pointer;font-weight:700;transition:all .3s;}
.login-toggle span:hover{text-shadow:0 0 12px var(--red-glow);color:#ff5252;}
.login-err{font-size:12px;color:#ff5252;text-align:center;display:none;padding:10px 14px;background:rgba(255,80,80,0.12);border-radius:10px;border:1px solid rgba(255,80,80,0.35);margin:0;}
.login-err.show{display:block;animation:shake .4s;}
@keyframes shake{0%,100%{transform:translateX(0);} 25%{transform:translateX(-5px);} 75%{transform:translateX(5px);}}
.login-field-label{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-secondary);margin-bottom:8px;display:block;}
.sync-indicator{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-secondary);padding:4px 8px;background:rgba(255,255,255,0.04);border-radius:12px;border:1px solid rgba(255,255,255,0.08);transition:all .3s;}
.sync-indicator:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.12);}
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--s-ongoing);flex-shrink:0;box-shadow:0 0 8px currentColor;}
.sync-dot.syncing{background:var(--s-morecoming);animation:pulse 1s infinite;}
.sync-dot.error{background:#ff5252;box-shadow:0 0 8px #ff5252;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.3;}}


/* ADD PAGE */
.add-body{max-width:540px;margin:0 auto;padding:28px 16px 100px;display:flex;flex-direction:column;gap:32px;}
.add-field-label{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-secondary);margin-bottom:12px;display:block;}
.add-title-input{font-family:var(--font-d);font-size:32px;letter-spacing:1px;background:transparent;border:none;border-bottom:2px solid rgba(255,255,255,0.15);border-radius:0;color:var(--white);padding:8px 0;width:100%;outline:none;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);}
.add-title-input:focus{border-bottom-color:var(--red);text-shadow:0 0 12px var(--red-glow);}
.add-title-input::placeholder{color:rgba(255,255,255,0.2);}
.type-pills{display:flex;flex-wrap:wrap;gap:10px;}
.type-pill{padding:10px 22px;border-radius:22px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.65);font-size:13px;font-weight:700;cursor:pointer;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);user-select:none;position:relative;overflow:hidden;}
.type-pill::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.1),transparent);opacity:0;transition:opacity .3s;}
.type-pill:hover{border-color:rgba(255,255,255,0.35);background:rgba(255,255,255,0.1);color:var(--white);}
.type-pill:hover::before{opacity:1;}
.type-pill.sel{background:var(--red);color:var(--white);border-color:var(--red);box-shadow:0 0 16px var(--red-glow);}
.status-pills{display:flex;flex-wrap:wrap;gap:10px;}
.status-pill{padding:10px 18px;border-radius:22px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.65);font-size:12px;font-weight:700;cursor:pointer;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);user-select:none;white-space:nowrap;position:relative;overflow:hidden;}
.status-pill::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.1),transparent);opacity:0;transition:opacity .3s;}
.status-pill:hover{border-color:rgba(255,255,255,0.35);background:rgba(255,255,255,0.1);color:var(--white);}
.status-pill:hover::before{opacity:1;}
.status-pill.sel[data-status="ongoing"]{background:var(--s-ongoing);color:#fff;border-color:var(--s-ongoing);box-shadow:0 0 12px rgba(34,197,94,0.3);}
.status-pill.sel[data-status="finished"]{background:var(--s-finished);color:#fff;border-color:var(--s-finished);box-shadow:0 0 12px var(--red-glow);}
.status-pill.sel[data-status="morecoming"]{background:var(--s-morecoming);color:#000;border-color:var(--s-morecoming);box-shadow:0 0 12px rgba(245,158,11,0.3);}
.status-pill.sel[data-status="abandoned"]{background:var(--s-abandoned);color:#fff;border-color:var(--s-abandoned);box-shadow:0 0 12px rgba(107,114,128,0.3);}
.poster-card{background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(255,255,255,0.04));border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:20px;display:flex;flex-direction:column;gap:14px;}
.poster-preview-wrap{display:none;position:relative;}
.poster-preview-wrap.show{display:block;}
.poster-preview-wrap img{width:100%;max-height:280px;object-fit:cover;border-radius:12px;display:block;box-shadow:0 12px 32px rgba(0,0,0,0.4);}
.poster-clear-btn{position:absolute;top:10px;right:10px;width:32px;height:32px;border-radius:10px;background:rgba(0,0,0,0.85);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);color:white;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;transition:all .2s;box-shadow:0 4px 12px rgba(0,0,0,0.4);}
.poster-clear-btn:hover{background:rgba(0,0,0,0.95);border-color:rgba(255,255,255,0.4);}
.poster-or{text-align:center;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-secondary);}
.upload-btn{background:linear-gradient(135deg,rgba(255,255,255,0.08),rgba(255,255,255,0.04));border:2px dashed rgba(255,255,255,0.25);color:var(--text-secondary);font-size:13px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;padding:16px;border-radius:14px;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);box-shadow:none;cursor:pointer;}
.upload-btn:hover{border-color:rgba(255,255,255,0.45);background:linear-gradient(135deg,rgba(255,255,255,0.12),rgba(255,255,255,0.08));color:var(--white);}
.add-save-btn{font-size:15px;font-weight:700;padding:16px;background:linear-gradient(135deg,var(--red),#ff1a1a);box-shadow:0 6px 24px var(--red-glow);width:100%;color:white;border:1px solid rgba(255,255,255,0.1);}
.add-save-btn:hover{box-shadow:0 12px 36px var(--red-glow);transform:translateY(-2px);}
.form-sep{display:flex;align-items:center;gap:10px;color:var(--text-secondary);font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;}
.form-sep::before,.form-sep::after{content:'';flex:1;height:1px;background:rgba(255,255,255,0.08);}


/* DETAIL */
.detail-hero{position:relative;width:100%;height:70vw;max-height:400px;min-height:280px;overflow:hidden;background:linear-gradient(135deg,rgba(0,0,0,0.3),rgba(229,9,20,0.1));}
.detail-bg{position:absolute;inset:-10%;background-size:cover;background-position:center 20%;filter:brightness(0.5) blur(4px);will-change:transform;transform:scale(1.05);}
.detail-vignette{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,0) 0%,rgba(0,0,0,0.1) 50%,rgba(0,0,0,0.75) 100%);backdrop-filter:blur(1px);}
.detail-hero-content{position:absolute;bottom:0;left:0;right:0;padding:0 16px 24px;display:flex;align-items:flex-end;gap:16px;animation:slideUp .5s cubic-bezier(0.25,0.46,0.45,0.94);}
@keyframes slideUp{from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);}}
.detail-thumb{width:90px;flex-shrink:0;border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,0.8);border:1px solid rgba(255,255,255,0.1);aspect-ratio:2/3;object-fit:cover;}
.detail-meta{flex:1;min-width:0;}
.detail-title{font-family:var(--font-d);font-size:32px;letter-spacing:1px;color:var(--white);line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:10px;text-shadow:0 4px 16px rgba(0,0,0,0.8);}
.detail-badges{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.detail-type-badge{color:var(--white);font-size:10px;font-weight:800;letter-spacing:0.5px;text-transform:uppercase;border-radius:8px;padding:4px 11px;box-shadow:0 2px 8px rgba(0,0,0,0.3);}
.detail-type-badge.type-movie{background:var(--c-movie);}
.detail-type-badge.type-series{background:var(--c-series);}
.detail-type-badge.type-anime{background:var(--c-anime);}
.detail-type-badge.type-manga{background:var(--c-manga);}
.detail-status-pill{font-size:10px;font-weight:800;letter-spacing:0.5px;text-transform:uppercase;border-radius:8px;padding:4px 11px;color:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.3);}
.detail-status-pill.s-ongoing{background:var(--s-ongoing);}
.detail-status-pill.s-finished{background:var(--s-finished);}
.detail-status-pill.s-morecoming{background:var(--s-morecoming);color:#000;}
.detail-status-pill.s-abandoned{background:var(--s-abandoned);}
.hero-edit-btn{position:absolute;top:16px;right:16px;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);border-radius:20px;padding:8px 16px;font-size:12px;color:rgba(255,255,255,0.9);cursor:pointer;font-family:var(--font);font-weight:700;width:auto;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);}
.hero-edit-btn:hover{background:rgba(0,0,0,0.95);color:var(--white);border-color:rgba(255,255,255,0.4);box-shadow:0 4px 12px rgba(0,0,0,0.4);}

.detail-body{padding:0 16px;max-width:580px;margin:0 auto;}
.d-label{font-size:11px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-secondary);margin:28px 0 14px;}
.edit-panel{background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(255,255,255,0.04));border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:18px;margin:16px 0;display:flex;flex-direction:column;gap:14px;transition:all .3s;}
.edit-panel:hover{border-color:rgba(255,255,255,0.15);box-shadow:0 4px 16px rgba(0,0,0,0.3);}
.edit-two{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.status-changer{background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(255,255,255,0.04));border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:18px;margin:16px 0;}
.notes-box{background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(255,255,255,0.04));border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:18px;margin:16px 0;}
.notes-save-row{display:flex;justify-content:flex-end;margin-top:12px;gap:8px;}
.notes-save-btn{width:auto;padding:10px 20px;font-size:13px;border-radius:10px;background:rgba(229,9,20,0.2);color:var(--red);border:1px solid rgba(229,9,20,0.3);font-weight:700;transition:all .3s;}
.notes-save-btn:hover{background:var(--red);color:white;}
.progress-box{background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(255,255,255,0.04));border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:20px;margin:16px 0;}
.progress-two{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}


/* EPISODE PILLS */
.season-block{margin-bottom:12px;border:1px solid rgba(255,255,255,0.07);border-radius:16px;overflow:hidden;background:rgba(255,255,255,0.02);transition:all .3s;}
.season-block:hover{border-color:rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);}
.season-head{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;cursor:pointer;background:rgba(255,255,255,0.03);user-select:none;transition:all .3s;}
.season-head:hover{background:rgba(255,255,255,0.07);}
.season-head-left{display:flex;align-items:center;gap:12px;font-size:14px;font-weight:700;color:var(--white);}
.season-ep-count{font-size:11px;color:var(--text-secondary);font-weight:600;}
.season-chev{font-size:10px;color:var(--text-secondary);transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);}
.season-chev.open{transform:rotate(180deg);}
.season-body{display:none;padding:14px 16px 16px;}
.season-body.open{display:block;animation:slideDown .3s cubic-bezier(0.25,0.46,0.45,0.94);}
@keyframes slideDown{from{opacity:0;max-height:0;} to{opacity:1;max-height:500px;}}
.ep-pills-row{display:flex;flex-wrap:wrap;gap:8px;}
.ep-pill{position:relative;width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;cursor:pointer;user-select:none;flex-shrink:0;background:linear-gradient(135deg,rgba(229,9,20,0.85),rgba(229,9,20,0.7));color:#fff;animation:pillPop .25s cubic-bezier(0.34,1.56,0.64,1);border:1px solid rgba(255,255,255,0.15);box-shadow:0 4px 12px rgba(229,9,20,0.3);transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);}
@keyframes pillPop{from{transform:scale(0);opacity:0;}to{transform:scale(1);opacity:1;}}
.ep-pill:hover{transform:translateY(-4px);box-shadow:0 8px 20px var(--red-glow);}
.ep-pill:active{transform:scale(0.92);}
.ep-pill .tip{position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#1c1c1c,#252525);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:7px 12px;white-space:nowrap;font-size:11px;font-weight:600;color:var(--white);pointer-events:none;opacity:0;transition:all .2s;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,0.8);}
.ep-pill .tip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#1c1c1c;}
.ep-pill:hover .tip{opacity:1;}
.ep-del{position:absolute;top:-8px;right:-8px;width:20px;height:20px;border-radius:50%;background:#ff5252;color:#fff;font-size:11px;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:10;box-shadow:0 2px 8px rgba(255,82,82,0.4);}
.ep-pill:hover .ep-del{display:flex;}
.done-row{background:linear-gradient(135deg,rgba(229,9,20,0.08),rgba(229,9,20,0.05));border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px;margin-top:10px;border:1px solid rgba(229,9,20,0.2);transition:all .3s;}
.done-row:hover{border-color:rgba(229,9,20,0.3);background:linear-gradient(135deg,rgba(229,9,20,0.12),rgba(229,9,20,0.08));}
.done-row .dr-icon{color:var(--red);font-size:14px;}
.done-row .dr-text{flex:1;font-size:13px;font-weight:700;color:var(--red);}
.done-row .dr-time{font-size:11px;color:var(--text-secondary);}
.done-row .dr-del{cursor:pointer;color:var(--text-secondary);font-size:16px;padding:4px 6px;border-radius:6px;transition:all .2s;}
.done-row .dr-del:hover{background:rgba(255,75,75,0.15);color:#ff5252;}


/* STATS */
.stats-body{max-width:500px;margin:0 auto;padding:20px 16px 90px;}
.stats-hero{text-align:center;padding:32px 0 28px;border-bottom:1px solid rgba(255,255,255,0.07);margin-bottom:20px;}
.stats-big{font-family:var(--font-d);font-size:88px;line-height:1;color:var(--white);letter-spacing:2px;}
.stats-sub{font-size:11px;color:var(--muted);font-weight:600;letter-spacing:2.5px;text-transform:uppercase;margin-top:4px;}
.stats-sec{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin:22px 0 10px;}
.stat-grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.stat-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:14px;padding:14px 16px;}
.stat-n{font-family:var(--font-d);font-size:38px;color:var(--white);line-height:1;letter-spacing:1px;}
.stat-l{font-size:11px;color:var(--muted);font-weight:600;margin-top:3px;}
.stat-bar-wrap{height:3px;background:rgba(255,255,255,0.08);border-radius:2px;margin-top:10px;overflow:hidden;}
.stat-bar{height:100%;border-radius:2px;width:0;transition:width .7s cubic-bezier(0.34,1.2,0.64,1);}
.type-rows{display:flex;flex-direction:column;gap:8px;}
.type-row{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:12px 14px;}
.type-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.type-n{font-size:13px;font-weight:600;color:var(--white);flex-shrink:0;width:52px;}
.type-bar-wrap{flex:1;height:5px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;}
.type-bar{height:100%;border-radius:3px;width:0;transition:width .7s cubic-bezier(0.34,1.2,0.64,1);}
.type-cnt{font-family:var(--font-d);font-size:22px;color:var(--white);letter-spacing:1px;flex-shrink:0;min-width:28px;text-align:right;}
.recent-list{display:flex;flex-direction:column;gap:6px;}
.recent-item{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:10px 14px;cursor:pointer;transition:background .15s;}
.recent-item:hover{background:rgba(255,255,255,0.07);}
.recent-thumb{width:36px;height:54px;object-fit:cover;border-radius:6px;flex-shrink:0;}
.recent-ph{width:36px;height:54px;border-radius:6px;background:#1c1c1c;flex-shrink:0;}
.recent-info{flex:1;min-width:0;}
.recent-name{font-size:13px;font-weight:600;color:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.recent-meta{font-size:11px;color:var(--muted);margin-top:2px;}
.recent-badge{font-size:8px;font-weight:800;letter-spacing:0.5px;text-transform:uppercase;border-radius:5px;padding:2px 7px;color:#fff;flex-shrink:0;}

/* PROFILE PAGE */
.profile-body{max-width:540px;margin:0 auto;padding:0;display:flex;flex-direction:column;gap:0;}
.profile-banner{position:relative;width:100%;height:180px;background:linear-gradient(135deg,rgba(0,0,0,0.6),rgba(229,9,20,0.15),rgba(0,128,255,0.08),rgba(0,0,0,0.6));overflow:hidden;cursor:pointer;transition:all .3s;border-bottom:1px solid rgba(255,255,255,0.1);}
.profile-banner::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,rgba(255,255,255,0.05),transparent);pointer-events:none;}
.profile-banner img{width:100%;height:100%;object-fit:cover;transition:filter .3s;}
.profile-banner:hover img{filter:brightness(1.2);}
.profile-banner-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.2);font-size:48px;background:linear-gradient(135deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));}
.profile-banner-upload{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);opacity:0;transition:opacity .3s;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.1);}
.profile-banner:hover .profile-banner-upload{opacity:1;}
.profile-avatar-section{display:flex;flex-direction:column;align-items:center;gap:18px;margin:-70px 16px 0;padding:40px 24px 28px;background:rgba(28,28,28,0.4);backdrop-filter:blur(40px);border:1px solid rgba(255,255,255,0.2);border-radius:24px;position:relative;z-index:10;box-shadow:0 -20px 60px rgba(0,0,0,0.9),inset 0 1px 0 rgba(255,255,255,0.1);transition:all .3s;}
.profile-avatar-section:hover{background:rgba(35,35,35,0.5);border-color:rgba(255,255,255,0.3);box-shadow:0 -24px 80px rgba(0,0,0,0.95),inset 0 1px 0 rgba(255,255,255,0.15);}
.profile-avatar-big{width:110px;height:110px;border-radius:16px;overflow:hidden;border:4px solid var(--red);background:linear-gradient(135deg,rgba(229,9,20,0.15),rgba(255,255,255,0.07));display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;box-shadow:0 12px 40px rgba(229,9,20,0.4),0 0 30px rgba(229,9,20,0.2);transition:all .3s;}
.profile-avatar-big:hover{transform:translateY(-4px);box-shadow:0 16px 50px rgba(229,9,20,0.5),0 0 40px rgba(229,9,20,0.3);}
.profile-avatar-big img{width:100%;height:100%;object-fit:cover;}
.profile-avatar-big-initials{font-family:var(--font-d);font-size:42px;color:var(--red);}
.profile-name-display{font-family:var(--font-d);font-size:32px;letter-spacing:2px;color:var(--white);text-align:center;}
.profile-email{font-size:12px;color:var(--text-secondary);text-align:center;}
.profile-section{background:rgba(30,30,30,0.4);backdrop-filter:blur(20px);border:1.5px solid rgba(255,255,255,0.15);border-radius:20px;padding:24px;display:flex;flex-direction:column;gap:14px;margin:0 16px;transition:all .3s;box-shadow:0 8px 32px rgba(0,0,0,0.6),inset 0 1px 0 rgba(255,255,255,0.1),inset 0 -1px 0 rgba(0,0,0,0.3);}
.profile-section:hover{background:rgba(40,40,40,0.5);border-color:rgba(255,255,255,0.25);box-shadow:0 12px 40px rgba(0,0,0,0.8),inset 0 1px 0 rgba(255,255,255,0.15),inset 0 -1px 0 rgba(0,0,0,0.4);}
.profile-section:last-child{margin-bottom:90px;}
.profile-section-title{font-size:11px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-secondary);}
.profile-bio-input{min-height:80px;line-height:1.6;}
.profile-signout{background:linear-gradient(135deg,rgba(229,9,20,0.15),rgba(229,9,20,0.1));color:var(--red);border:1.5px solid rgba(229,9,20,0.3);font-size:14px;font-weight:700;padding:14px;border-radius:12px;transition:all .3s;}
.profile-signout:hover{background:linear-gradient(135deg,rgba(229,9,20,0.25),rgba(229,9,20,0.2));border-color:rgba(229,9,20,0.5);box-shadow:0 0 16px rgba(229,9,20,0.2);}
.profile-section button:not(.profile-signout){background:linear-gradient(135deg,var(--red),#ff1a1a);color:white;border:1px solid rgba(255,255,255,0.1);font-weight:700;box-shadow:0 4px 16px var(--red-glow);}
.profile-section button:not(.profile-signout):hover{transform:translateY(-2px);box-shadow:0 8px 24px var(--red-glow);}


/* TOAST */
.nf-toast{position:fixed;bottom:calc(var(--nav-h) + 12px);left:50%;transform:translateX(-50%) translateY(20px);background:#1c1c1c;border:1px solid rgba(255,255,255,0.1);color:var(--white);padding:10px 20px;border-radius:30px;font-size:13px;font-weight:500;z-index:500;transition:transform .3s cubic-bezier(0.34,1.56,0.64,1),opacity .3s;white-space:nowrap;pointer-events:none;opacity:0;box-shadow:0 4px 20px rgba(0,0,0,0.7);display:flex;align-items:center;gap:8px;}
.nf-toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.detail-bottom-pad{height:90px;}
.swipe-hint{position:fixed;top:50%;left:16px;transform:translateY(-50%);width:4px;height:60px;border-radius:2px;background:rgba(255,255,255,0.15);opacity:0;transition:opacity .3s;pointer-events:none;z-index:300;}
.swipe-hint.show{opacity:1;}
</style>
</head>
<body>

<input type="file" id="importFile" hidden accept=".json">
<input type="file" id="addPosterFile" hidden accept="image/*">
<input type="file" id="avatarFile" hidden accept="image/*">
<input type="file" id="bannerFile" hidden accept="image/*">
<div class="nf-toast" id="toast"><span id="toastIcon"></span><span id="toastMsg"></span></div>
<div class="swipe-hint" id="swipeHint"></div>

<!-- LOGIN PAGE -->
<div class="page page-home" id="loginPage" style="display:none;">
  <div class="login-wrap">
    <div class="login-logo">TRACKR</div>
    <div class="login-sub">Your personal media tracker</div>
    <div class="login-card">
      <div class="login-title" id="loginTitle">Welcome back</div>
      <div class="login-err" id="loginErr"></div>
      <div>
        <span class="login-field-label">Email</span>
        <input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="email">
      </div>
      <div>
        <span class="login-field-label">Password</span>
        <input type="password" id="loginPass" placeholder="••••••••" autocomplete="current-password">
      </div>
      <button id="loginBtn">Sign In</button>
      <div class="login-toggle" id="loginToggle">Don't have an account? <span id="loginSwitch">Sign Up</span></div>
    </div>
  </div>
</div>

<!-- HOME PAGE -->
<div class="page page-home hidden" id="home">
  <header class="nf-header">
    <div class="nf-logo">TRACKR</div>
    <div class="nf-header-right">
      <!-- Sync indicator -->
      <div class="sync-indicator" id="syncIndicator" style="display:none">
        <div class="sync-dot" id="syncDot"></div>
        <span id="syncLabel">Synced</span>
      </div>
      <!-- More menu -->
      <div class="more-wrap">
        <div class="nf-icon-btn" id="moreBtn" title="More">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>
        </div>
        <div class="more-drop" id="moreDrop">
          <div class="more-item" id="miExport">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            Export JSON
          </div>
          <div class="more-item" id="miImport">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Import JSON
          </div>
          <div class="more-item danger" id="miClear">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>
            Clear All
          </div>
        </div>
      </div>
      <!-- Avatar -->
      <div class="avatar-btn" id="avatarBtn">
        <span class="avatar-initials" id="avatarInitials">?</span>
      </div>
    </div>
  </header>
  <div class="nf-controls">
    <div class="nf-search-row">
      <div class="nf-search-wrap">
        <svg class="si" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input id="searchInput" placeholder="Search titles..." autocomplete="off">
      </div>
      <div class="sort-wrap">
        <div class="sort-btn" id="sortBtn">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="21" y1="10" x2="7" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="7" y2="18"/></svg>
          <span class="sort-val" id="sortLabel">Recent</span>
        </div>
        <div class="sort-drop" id="sortDrop">
          <div class="sort-opt sel" data-sort="lastEntry">Last Entry</div>
          <div class="sort-opt" data-sort="alpha">A &#8594; Z</div>
          <div class="sort-opt" data-sort="oldest">Oldest First</div>
        </div>
      </div>
    </div>
    <div class="nf-chips" id="filterRow">
      <div class="nf-chip active" data-type="all">All</div>
      <div class="nf-chip" data-type="movie">Movies</div>
      <div class="nf-chip" data-type="series">Series</div>
      <div class="nf-chip" data-type="anime">Anime</div>
      <div class="nf-chip" data-type="manga">Manga</div>
    </div>
  </div>
  <div class="nf-tabs">
    <div class="nf-tab active" data-tab="ongoing">Ongoing <span class="nf-tab-badge" id="cntOngoing">0</span></div>
    <div class="nf-tab" data-tab="finished">Finished <span class="nf-tab-badge" id="cntFinished">0</span></div>
    <div class="nf-tab" data-tab="morecoming">More Coming <span class="nf-tab-badge" id="cntMorecoming">0</span></div>
    <div class="nf-tab" data-tab="abandoned">Abandoned <span class="nf-tab-badge" id="cntAbandoned">0</span></div>
  </div>
  <div class="nf-grid" id="grid"></div>
</div>

<!-- ADD PAGE -->
<div class="page page-secondary" id="addPage">
  <div class="nf-page-header">
    <div class="nf-back-btn ripple-host" id="backFromAdd">&#8592;</div>
    <div class="nf-page-title">NEW TITLE</div>
  </div>
  <div class="add-body">
    <div><span class="add-field-label">Title</span><input class="add-title-input" id="name" placeholder="What are you watching?" autocomplete="off"></div>
    <div>
      <span class="add-field-label">Type</span>
      <div class="type-pills" id="typePills">
        <div class="type-pill sel" data-type="movie">Movie</div>
        <div class="type-pill" data-type="series">Series</div>
        <div class="type-pill" data-type="anime">Anime</div>
        <div class="type-pill" data-type="manga">Manga</div>
      </div>
    </div>
    <div>
      <span class="add-field-label">Status</span>
      <div class="status-pills" id="addStatusPills">
        <div class="status-pill sel" data-status="ongoing">Ongoing</div>
        <div class="status-pill" data-status="finished">Finished</div>
        <div class="status-pill" data-status="morecoming">More Coming</div>
        <div class="status-pill" data-status="abandoned">Abandoned</div>
      </div>
    </div>
    <div>
      <span class="add-field-label">Poster</span>
      <div class="poster-card">
        <div class="poster-preview-wrap" id="addPreviewWrap"><img id="addPreviewImg" alt=""><button class="poster-clear-btn" id="addClearImg">&#215;</button></div>
        <input id="posterUrl" placeholder="Paste image URL...">
        <div class="poster-or">or</div>
        <button class="upload-btn" id="addUploadBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          Upload from device
        </button>
      </div>
    </div>
    <button class="add-save-btn" id="saveContentBtn">Add to My List</button>
  </div>
</div>

<!-- DETAIL PAGE -->
<div class="page page-secondary" id="detail">
  <div class="nf-page-header">
    <div class="nf-back-btn ripple-host" id="backFromDetail">&#8592;</div>
    <div class="nf-page-title" id="detailName"></div>
  </div>
  <div class="detail-hero" id="detailHero">
    <div class="detail-bg" id="detailBg"></div>
    <div class="detail-vignette"></div>
    <div class="detail-hero-content">
      <img class="detail-thumb" id="detailPoster" alt="">
      <div class="detail-meta">
        <div class="detail-title" id="detailTitle"></div>
        <div class="detail-badges">
          <span class="detail-type-badge" id="detailBadge"></span>
          <span class="detail-status-pill" id="detailStatusPill"></span>
        </div>
      </div>
    </div>
    <button class="hero-edit-btn" id="editToggleBtn">Edit</button>
  </div>
  <div class="detail-body">
    <div class="edit-panel hidden" id="editPanel">
      <div style="font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted)">Edit Details</div>
      <input id="editName" placeholder="Title">
      <select id="editType"><option value="movie">Movie</option><option value="series">Series</option><option value="anime">Anime</option><option value="manga">Manga</option></select>
      <input id="editPosterUrl" placeholder="Poster URL">
      <div class="form-sep">or upload new image</div>
      <input id="editPosterFile" type="file" accept="image/*">
      <div class="edit-two"><button class="secondary" id="editCancelBtn">Cancel</button><button id="editSaveBtn">Save</button></div>
    </div>
    <div class="status-changer">
      <div class="d-label" style="margin-top:0">Status</div>
      <div class="status-pills" id="detailStatusPills">
        <div class="status-pill" data-status="ongoing">Ongoing</div>
        <div class="status-pill" data-status="finished">Finished</div>
        <div class="status-pill" data-status="morecoming">More Coming</div>
        <div class="status-pill" data-status="abandoned">Abandoned</div>
      </div>
    </div>
    <div class="notes-box">
      <div class="d-label" style="margin-top:0">Notes</div>
      <textarea id="notesInput" placeholder="Where you left off, thoughts, reminders..."></textarea>
      <div class="notes-save-row"><button class="notes-save-btn" id="saveNotesBtn">Save Note</button></div>
    </div>
    <div id="progressSection" class="progress-box">
      <div style="font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:14px">Log Progress</div>
      <div class="progress-two">
        <input id="seasonInput" type="number" min="1" placeholder="Season">
        <input id="episodeInput" type="number" min="1" placeholder="Episode">
      </div>
      <button id="saveProgressBtn">Save Progress</button>
    </div>
    <div class="d-label">Watch History</div>
    <div id="historyList"></div>
    <div class="detail-bottom-pad"></div>
  </div>
</div>

<!-- STATS PAGE -->
<div class="page page-secondary" id="statsPage">
  <div class="nf-page-header">
    <div class="nf-back-btn ripple-host" id="backFromStats">&#8592;</div>
    <div class="nf-page-title">MY STATS</div>
  </div>
  <div class="stats-body">
    <div class="stats-hero">
      <div class="stats-big" id="statTotal">0</div>
      <div class="stats-sub">Total Tracked</div>
    </div>
    <div class="stats-sec">By Status</div>
    <div class="stat-grid2">
      <div class="stat-card"><div class="stat-n" id="statOngoing">0</div><div class="stat-l">Ongoing</div><div class="stat-bar-wrap"><div class="stat-bar" id="barOngoing" style="background:var(--s-ongoing)"></div></div></div>
      <div class="stat-card"><div class="stat-n" id="statFinished">0</div><div class="stat-l">Finished</div><div class="stat-bar-wrap"><div class="stat-bar" id="barFinished" style="background:var(--s-finished)"></div></div></div>
      <div class="stat-card"><div class="stat-n" id="statMorecoming">0</div><div class="stat-l">More Coming</div><div class="stat-bar-wrap"><div class="stat-bar" id="barMorecoming" style="background:var(--s-morecoming)"></div></div></div>
      <div class="stat-card"><div class="stat-n" id="statAbandoned">0</div><div class="stat-l">Abandoned</div><div class="stat-bar-wrap"><div class="stat-bar" id="barAbandoned" style="background:var(--s-abandoned)"></div></div></div>
    </div>
    <div class="stats-sec">By Type</div>
    <div class="type-rows" id="typeRows"></div>
    <div class="stats-sec">Episodes &amp; Seasons</div>
    <div class="stat-grid2">
      <div class="stat-card"><div class="stat-n" id="statEps">0</div><div class="stat-l">Episodes Logged</div></div>
      <div class="stat-card"><div class="stat-n" id="statSeasons">0</div><div class="stat-l">Seasons Logged</div></div>
    </div>
    <div class="stats-sec">Recently Active</div>
    <div class="recent-list" id="recentList"></div>
    <div style="height:40px"></div>
  </div>
</div>

<!-- PROFILE PAGE -->
<div class="page page-secondary" id="profilePage">
  <div class="nf-page-header">
    <div class="nf-back-btn ripple-host" id="backFromProfile">&#8592;</div>
    <div class="nf-page-title">PROFILE</div>
  </div>
  <div class="profile-body">
    <div class="profile-banner" id="profileBanner" title="Click to change banner">
      <div class="profile-banner-placeholder">🎨</div>
      <div class="profile-banner-upload">📷 Change</div>
    </div>
    <div class="profile-avatar-section">
      <div class="profile-avatar-big" id="profileAvatarBig">
        <span class="profile-avatar-big-initials" id="profileBigInitials">?</span>
      </div>
      <div class="profile-name-display" id="profileNameDisplay">USER</div>
      <div class="profile-email" id="profileEmailDisplay"></div>
    </div>
    <div class="profile-section">
      <div class="profile-section-title">✨ Edit Profile</div>
      <div>
        <span class="add-field-label">Display Name</span>
        <input id="profileNameInput" placeholder="Your display name">
      </div>
      <div>
        <span class="add-field-label">Bio</span>
        <textarea id="profileBioInput" placeholder="Tell us about yourself..." class="profile-bio-input"></textarea>
      </div>
      <button id="saveProfileBtn">Save Profile</button>
    </div>
    <div class="profile-section">
      <div class="profile-section-title">🔒 Account</div>
      <button class="profile-signout" id="signOutBtn">Sign Out</button>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bot-nav" id="botNav">
  <div class="bot-nav-item active" id="navHome">
    <div class="bot-nav-pip"></div>
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    <span class="bot-nav-label">Home</span>
  </div>
  <div class="bot-nav-item" id="navAdd">
    <div class="bot-add">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </div>
  </div>
  <div class="bot-nav-item" id="navStats">
    <div class="bot-nav-pip"></div>
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
    <span class="bot-nav-label">Stats</span>
  </div>
</nav>

<script>
/* SUPABASE */
const SUPA_URL='https://gyfiwmbskbmdkwlsvtty.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5Zml3bWJza2JtZGt3bHN2dHR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MzY4NjMsImV4cCI6MjA4NzMxMjg2M30.GdDyUJ2JY-AkGcHPIeoq3Ehk4dfmF5fsy-CAhuNtfTE';
const sb=supabase.createClient(SUPA_URL,SUPA_KEY);

/* STATE */
let currentUser=null,currentProfile=null,current=null,activeDrop=null;
let activeTab="ongoing",activeType="all",activeSort="lastEntry",searchQ="";
let addPosterData="",currentPage="loginPage";
const _cache={};
const SLABELS={ongoing:"Ongoing",finished:"Finished",morecoming:"More Coming",abandoned:"Abandoned"};
const SCLS={ongoing:"s-ongoing",finished:"s-finished",morecoming:"s-morecoming",abandoned:"s-abandoned"};
const SCRD={ongoing:"nf-st-ongoing",finished:"nf-st-finished",morecoming:"nf-st-morecoming",abandoned:"nf-st-abandoned"};
const TCLR={movie:"var(--c-movie)",series:"var(--c-series)",anime:"var(--c-anime)",manga:"var(--c-manga)"};
const PH="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='300'%3E%3Crect fill='%23141414' width='200' height='300'/%3E%3C/svg%3E";

/* TOAST */
let _tt;
function toast(msg,icon){
  const el=document.getElementById("toast");
  document.getElementById("toastMsg").textContent=msg;
  document.getElementById("toastIcon").textContent=icon||"";
  el.classList.add("show");clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove("show"),2600);
}

/* SYNC INDICATOR */
let lastSyncTime=null;
function setSyncStatus(status){
  const ind=document.getElementById("syncIndicator");
  const dot=document.getElementById("syncDot");
  const lbl=document.getElementById("syncLabel");
  if(!currentUser){ind.style.display="none";return;}
  ind.style.display="flex";
  dot.className="sync-dot"+(status==="syncing"?" syncing":status==="error"?" error":"");
  
  let text=status==="syncing"?"Syncing...":status==="error"?"Sync error":"Synced";
  
  if(status==="synced"){
    lastSyncTime=new Date();
  }
  
  if(lastSyncTime&&status!=="syncing"){
    const now=new Date();
    const diff=Math.floor((now-lastSyncTime)/1000);
    let timeStr;
    if(diff<60){timeStr="just now";}
    else if(diff<3600){timeStr=Math.floor(diff/60)+"m ago";}
    else if(diff<86400){timeStr=Math.floor(diff/3600)+"h ago";}
    else{timeStr=lastSyncTime.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});}
    text+=" • "+timeStr;
  }
  
  lbl.textContent=text;
}

/* RIPPLE */
function addRipple(el){
  el.addEventListener("pointerdown",e=>{
    const r=el.getBoundingClientRect(),size=Math.max(r.width,r.height)*2;
    const rip=document.createElement("span");rip.className="ripple";
    rip.style.cssText="width:"+size+"px;height:"+size+"px;left:"+(e.clientX-r.left-size/2)+"px;top:"+(e.clientY-r.top-size/2)+"px";
    el.appendChild(rip);setTimeout(()=>rip.remove(),600);
  });
}
document.querySelectorAll(".ripple-host").forEach(addRipple);

/* PAGE NAV */
function navigateTo(pageId){
  if(pageId===currentPage)return;
  const from=document.getElementById(currentPage);
  const to=document.getElementById(pageId);
  to.classList.remove("swipe-back");
  if(pageId==="home"||pageId==="loginPage"){
    from.classList.add("swipe-back");
    setTimeout(()=>{from.classList.remove("active","swipe-back");},320);
    to.classList.remove("hidden");
    to.style.display="";
    setNavActive("home");
  } else {
    from.classList.add("hidden");
    to.classList.add("active");
    to.classList.remove("hidden");
    setNavActive(pageId);
  }
  currentPage=pageId;
  const showNav=!["detail","addPage","loginPage"].includes(pageId);
  document.getElementById("botNav").style.display=showNav?"flex":"none";
}
function setNavActive(pageId){
  document.querySelectorAll(".bot-nav-item").forEach(i=>i.classList.remove("active"));
  if(pageId==="home")document.getElementById("navHome").classList.add("active");
  if(pageId==="statsPage")document.getElementById("navStats").classList.add("active");
}

/* SWIPE BACK */
function initSwipeBack(pageEl,onBack){
  let sx=0,dragging=false,startedFromEdge=false;
  const hint=document.getElementById("swipeHint");
  pageEl.addEventListener("touchstart",e=>{sx=e.touches[0].clientX;startedFromEdge=sx<40;dragging=false;if(startedFromEdge)hint.classList.add("show");},{passive:true});
  pageEl.addEventListener("touchmove",e=>{
    if(!startedFromEdge)return;
    const dx=e.touches[0].clientX-sx,dy=e.touches[0].clientY-e.touches[0].clientY;
    if(!dragging&&dx>0)dragging=true;
    if(dragging){pageEl.style.transform="translateX("+Math.max(0,dx)+"px)";pageEl.style.transition="none";const pct=Math.min(dx/window.innerWidth,1);document.getElementById("home").style.transform="translateX("+(-30+pct*30)+"%)";document.getElementById("home").style.opacity=0.7+pct*0.3;document.getElementById("home").style.transition="none";}
  },{passive:true});
  pageEl.addEventListener("touchend",e=>{
    hint.classList.remove("show");
    if(!dragging){pageEl.style.transform="";pageEl.style.transition="";return;}
    const dx=e.changedTouches[0].clientX-sx;
    pageEl.style.transform="";pageEl.style.transition="";
    document.getElementById("home").style.transform="";document.getElementById("home").style.opacity="";document.getElementById("home").style.transition="";
    dragging=false;startedFromEdge=false;
    if(dx>window.innerWidth*0.35)onBack();
  },{passive:true});
}

/* TAB SWIPE */
function initTabSwipe(){
  const tabs=["ongoing","finished","morecoming","abandoned"];
  const grid=document.getElementById("grid");
  let tsx=0,tDragging=false;
  grid.addEventListener("touchstart",e=>{tsx=e.touches[0].clientX;tDragging=false;},{passive:true});
  grid.addEventListener("touchmove",e=>{const dx=e.touches[0].clientX-tsx,dy=e.touches[0].clientY-e.touches[0].clientY;if(!tDragging&&Math.abs(dx)>12)tDragging=true;},{passive:true});
  grid.addEventListener("touchend",e=>{
    if(!tDragging)return;const dx=e.changedTouches[0].clientX-tsx;
    if(Math.abs(dx)<50)return;
    const idx=tabs.indexOf(activeTab);let next=idx+(dx<0?1:-1);
    if(next<0||next>=tabs.length)return;
    activeTab=tabs[next];
    document.querySelectorAll(".nf-tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===activeTab));
    renderGrid();
  },{passive:true});
}

/* CLOSE DROPS */
function closeAll(){if(activeDrop){activeDrop.remove();activeDrop=null;}document.getElementById("sortDrop")?.classList.remove("open");document.getElementById("sortBtn")?.classList.remove("open");document.getElementById("moreDrop")?.classList.remove("open");}
document.addEventListener("click",closeAll);

/* AUTH */
async function initAuth(){
  const{data:{session}}=await sb.auth.getSession();
  if(session){
    currentUser=session.user;
    await loadProfile();
    showHome();
  } else {
    showLogin();
  }
  sb.auth.onAuthStateChange(async(event,session)=>{
    if(session){currentUser=session.user;await loadProfile();showHome();}
    else{currentUser=null;currentProfile=null;showLogin();}
  });
}

function showLogin(){
  document.getElementById("loginPage").style.display="flex";
  document.getElementById("home").classList.add("hidden");
  document.getElementById("botNav").style.display="none";
  currentPage="loginPage";
}
function showHome(){
  document.getElementById("loginPage").style.display="none";
  document.getElementById("home").classList.remove("hidden");
  document.getElementById("botNav").style.display="flex";
  currentPage="home";
  updateAvatarUI();
  setSyncStatus("synced");
  loadAll();
}

let loginMode="signin";
document.getElementById("loginSwitch").addEventListener("click",()=>{
  loginMode=loginMode==="signin"?"signup":"signin";
  document.getElementById("loginTitle").textContent=loginMode==="signin"?"Welcome back":"Create account";
  document.getElementById("loginBtn").textContent=loginMode==="signin"?"Sign In":"Sign Up";
  document.getElementById("loginToggle").innerHTML=loginMode==="signin"?"Don't have an account? <span id='loginSwitch'>Sign Up</span>":"Already have an account? <span id='loginSwitch'>Sign In</span>";
  document.getElementById("loginSwitch").addEventListener("click",arguments.callee);
  document.getElementById("loginErr").classList.remove("show");
});
document.getElementById("loginBtn").addEventListener("click",async()=>{
  const email=document.getElementById("loginEmail").value.trim();
  const pass=document.getElementById("loginPass").value;
  const err=document.getElementById("loginErr");
  if(!email||!pass){err.textContent="Please fill in all fields";err.classList.add("show");return;}
  document.getElementById("loginBtn").textContent="Please wait...";
  document.getElementById("loginBtn").disabled=true;
  let result;
  if(loginMode==="signup"){result=await sb.auth.signUp({email,password:pass});}
  else{result=await sb.auth.signInWithPassword({email,password:pass});}
  document.getElementById("loginBtn").disabled=false;
  document.getElementById("loginBtn").textContent=loginMode==="signin"?"Sign In":"Sign Up";
  if(result.error){err.textContent=result.error.message;err.classList.add("show");}
  else{err.classList.remove("show");}
});

/* PROFILE */
async function loadProfile(){
  if(!currentUser)return;
  const{data}=await sb.from("profiles").select("*").eq("id",currentUser.id).single();
  if(data){currentProfile=data;}
  else{
    await sb.from("profiles").insert({id:currentUser.id,display_name:currentUser.email.split("@")[0],bio:"",banner_url:null});
    currentProfile={id:currentUser.id,display_name:currentUser.email.split("@")[0],avatar_url:null,bio:"",banner_url:null};
  }
}
function updateAvatarUI(){
  const name=currentProfile?.display_name||currentUser?.email?.split("@")[0]||"?";
  const initials=name.charAt(0).toUpperCase();
  const avatarUrl=currentProfile?.avatar_url;
  const btn=document.getElementById("avatarBtn");
  if(avatarUrl){btn.innerHTML='<img src="'+avatarUrl+'" alt="">';}
  else{btn.innerHTML='<span class="avatar-initials">'+initials+'</span>';}
}
function showProfile(){
  navigateTo("profilePage");
  const name=currentProfile?.display_name||currentUser?.email?.split("@")[0]||"User";
  const bio=currentProfile?.bio||"";
  const bannerUrl=currentProfile?.banner_url;
  document.getElementById("profileNameDisplay").textContent=name.toUpperCase();
  document.getElementById("profileEmailDisplay").textContent=currentUser?.email||"";
  document.getElementById("profileNameInput").value=name;
  document.getElementById("profileBioInput").value=bio;
  // Update banner
  const banner=document.getElementById("profileBanner");
  if(bannerUrl){
    banner.innerHTML='<img src="'+bannerUrl+'" alt=""><div class="profile-banner-upload">📷 Change</div>';
  }else{
    banner.innerHTML='<div class="profile-banner-placeholder">🎨</div><div class="profile-banner-upload">📷 Change</div>';
  }
  banner.onclick=()=>document.getElementById("bannerFile").click();
  // Update avatar
  const avatarUrl=currentProfile?.avatar_url;
  const big=document.getElementById("profileAvatarBig");
  if(avatarUrl){big.innerHTML='<img src="'+avatarUrl+'" alt="">';}
  else{big.innerHTML='<span class="profile-avatar-big-initials">'+(name.charAt(0).toUpperCase())+'</span>';}
  big.onclick=()=>document.getElementById("avatarFile").click();
}
document.getElementById("saveProfileBtn").addEventListener("click",async()=>{
  const name=document.getElementById("profileNameInput").value.trim();
  const bio=document.getElementById("profileBioInput").value.trim();
  if(!name)return;
  await sb.from("profiles").update({display_name:name,bio:bio}).eq("id",currentUser.id);
  currentProfile.display_name=name;
  currentProfile.bio=bio;
  document.getElementById("profileNameDisplay").textContent=name.toUpperCase();
  updateAvatarUI();toast("Profile saved ✨","✓");
});
document.getElementById("bannerFile").addEventListener("change",async e=>{
  const f=e.target.files[0];if(!f)return;
  toast("Uploading banner...","⏳");
  const path=currentUser.id+"/banner."+f.name.split(".").pop();
  const{error}=await sb.storage.from("media").upload(path,f,{upsert:true});
  if(error){toast("Upload failed","⚠️");return;}
  const{data:{publicUrl}}=sb.storage.from("media").getPublicUrl(path);
  await sb.from("profiles").update({banner_url:publicUrl}).eq("id",currentUser.id);
  currentProfile.banner_url=publicUrl;showProfile();toast("Banner updated ✨","✓");
  e.target.value="";
});
document.getElementById("avatarFile").addEventListener("change",async e=>{
  const f=e.target.files[0];if(!f)return;
  toast("Uploading...","⏳");
  const path=currentUser.id+"/avatar."+f.name.split(".").pop();
  const{error}=await sb.storage.from("media").upload(path,f,{upsert:true});
  if(error){toast("Upload failed","⚠️");return;}
  const{data:{publicUrl}}=sb.storage.from("media").getPublicUrl(path);
  await sb.from("profiles").update({avatar_url:publicUrl}).eq("id",currentUser.id);
  currentProfile.avatar_url=publicUrl;updateAvatarUI();showProfile();toast("Avatar updated ✨","✓");
  e.target.value="";
});
document.getElementById("signOutBtn").addEventListener("click",async()=>{
  await sb.auth.signOut();Object.keys(_cache).forEach(k=>delete _cache[k]);goHome();
});
document.getElementById("avatarBtn").addEventListener("click",()=>showProfile());
document.getElementById("backFromProfile").addEventListener("click",()=>goHome());

/* MORE MENU */
document.getElementById("moreBtn").addEventListener("click",e=>{
  e.stopPropagation();
  const drop=document.getElementById("moreDrop");
  const isOpen=drop.classList.contains("open");
  closeAll();
  if(!isOpen)drop.classList.add("open");
});
document.getElementById("moreDrop").addEventListener("click",e=>e.stopPropagation());
document.getElementById("miExport").addEventListener("click",()=>{closeAll();exportData();});
document.getElementById("miImport").addEventListener("click",()=>{closeAll();document.getElementById("importFile").click();});
document.getElementById("miClear").addEventListener("click",()=>{closeAll();confirmClearAll();});

/* NAV */
document.getElementById("navHome").addEventListener("click",()=>goHome());
document.getElementById("navAdd").addEventListener("click",()=>showAdd());
document.getElementById("navStats").addEventListener("click",()=>showStats());
document.getElementById("backFromAdd").addEventListener("click",()=>goHome());
document.getElementById("backFromDetail").addEventListener("click",()=>goHome());
document.getElementById("backFromStats").addEventListener("click",()=>goHome());
document.getElementById("saveContentBtn").addEventListener("click",addContent);
document.getElementById("saveProgressBtn").addEventListener("click",addProgress);
document.getElementById("saveNotesBtn").addEventListener("click",saveNotes);
document.getElementById("editToggleBtn").addEventListener("click",toggleEditPanel);
document.getElementById("editCancelBtn").addEventListener("click",toggleEditPanel);
document.getElementById("editSaveBtn").addEventListener("click",saveEdit);
document.getElementById("addUploadBtn").addEventListener("click",()=>document.getElementById("addPosterFile").click());
document.getElementById("addPosterFile").addEventListener("change",e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{addPosterData=r.result;document.getElementById("posterUrl").value="";showAddPreview(r.result);};r.readAsDataURL(f);});
document.getElementById("addClearImg").addEventListener("click",()=>{addPosterData="";document.getElementById("posterUrl").value="";document.getElementById("addPosterFile").value="";document.getElementById("addPreviewWrap").classList.remove("show");});
document.getElementById("posterUrl").addEventListener("input",e=>{const v=e.target.value.trim();if(v){addPosterData="";showAddPreview(v);}else document.getElementById("addPreviewWrap").classList.remove("show");});
function showAddPreview(src){const img=document.getElementById("addPreviewImg"),w=document.getElementById("addPreviewWrap");img.src=src;img.onload=()=>w.classList.add("show");img.onerror=()=>w.classList.remove("show");}
document.getElementById("typePills").addEventListener("click",e=>{const p=e.target.closest(".type-pill");if(!p)return;document.querySelectorAll(".type-pill").forEach(x=>x.classList.remove("sel"));p.classList.add("sel");});
document.getElementById("addStatusPills").addEventListener("click",e=>{const p=e.target.closest(".status-pill");if(!p)return;document.querySelectorAll("#addStatusPills .status-pill").forEach(x=>x.classList.remove("sel"));p.classList.add("sel");});
document.getElementById("detailStatusPills").addEventListener("click",e=>{const p=e.target.closest(".status-pill");if(!p||!current)return;changeStatus(p.dataset.status);});
document.querySelectorAll(".nf-tab").forEach(t=>t.addEventListener("click",()=>{document.querySelectorAll(".nf-tab").forEach(x=>x.classList.remove("active"));t.classList.add("active");activeTab=t.dataset.tab;renderGrid();}));
document.getElementById("filterRow").addEventListener("click",e=>{const c=e.target.closest(".nf-chip[data-type]");if(!c)return;document.querySelectorAll(".nf-chip[data-type]").forEach(x=>x.classList.remove("active"));c.classList.add("active");activeType=c.dataset.type;renderGrid();});
document.getElementById("sortBtn").addEventListener("click",e=>{e.stopPropagation();const d=document.getElementById("sortDrop"),b=document.getElementById("sortBtn"),o=d.classList.contains("open");closeAll();if(!o){d.classList.add("open");b.classList.add("open");}});
document.getElementById("sortDrop").addEventListener("click",e=>{e.stopPropagation();const o=e.target.closest(".sort-opt");if(!o)return;document.querySelectorAll(".sort-opt").forEach(x=>x.classList.remove("sel"));o.classList.add("sel");activeSort=o.dataset.sort;document.getElementById("sortLabel").textContent={lastEntry:"Recent",alpha:"A\u2013Z",oldest:"Oldest"}[activeSort];closeAll();renderGrid();});
document.getElementById("searchInput").addEventListener("input",e=>{searchQ=e.target.value.trim().toLowerCase();renderGrid();});
document.getElementById("importFile").addEventListener("change",importData);

/* PARALLAX */
document.getElementById("detail").addEventListener("scroll",()=>{
  const scroll=document.getElementById("detail").scrollTop;
  document.getElementById("detailBg").style.transform="translateY("+scroll*0.35+"px)";
},{passive:true});

/* SWIPE INIT */
initSwipeBack(document.getElementById("detail"),()=>goHome());
initSwipeBack(document.getElementById("addPage"),()=>goHome());
initSwipeBack(document.getElementById("statsPage"),()=>goHome());
initSwipeBack(document.getElementById("profilePage"),()=>goHome());
initTabSwipe();

/* SUPABASE DATA */
async function loadAll(){
  if(!currentUser)return;
  setSyncStatus("syncing");
  try{
    const[{data:items},{data:logs}]=await Promise.all([
      sb.from("content").select("*").eq("user_id",currentUser.id),
      sb.from("logs").select("*").eq("user_id",currentUser.id)
    ]);
    Object.keys(_cache).forEach(k=>delete _cache[k]);
    (items||[]).forEach(c=>{
      const cl=(logs||[]).filter(l=>l.content_id===c.id);
      const epl=cl.filter(l=>!l.completed).sort((a,b)=>(b.timestamp||"").localeCompare(a.timestamp||""));
      const times=cl.map(l=>l.timestamp).filter(Boolean).sort();
      const le=epl[0];
      const lastEp=le?(c.type==="manga"?"Ch "+le.episode:"S"+(le.season||1)+" E"+le.episode):"";
      _cache[c.id]={...c,status:c.status||"ongoing",_last:times.length?times[times.length-1]:null,_lastEp:lastEp};
    });
    setSyncStatus("synced");
    renderGrid();
  }catch(e){setSyncStatus("error");toast("Sync error","⚠️");}
}

/* RENDER GRID */
function renderGrid(){
  const grid=document.getElementById("grid");grid.innerHTML="";
  const all=Object.values(_cache);
  document.getElementById("cntOngoing").textContent=all.filter(c=>c.status==="ongoing").length;
  document.getElementById("cntFinished").textContent=all.filter(c=>c.status==="finished").length;
  document.getElementById("cntMorecoming").textContent=all.filter(c=>c.status==="morecoming").length;
  document.getElementById("cntAbandoned").textContent=all.filter(c=>c.status==="abandoned").length;
  let items=all.filter(c=>c.status===activeTab);
  if(activeType!=="all")items=items.filter(c=>c.type===activeType);
  if(searchQ)items=items.filter(c=>c.name.toLowerCase().includes(searchQ));
  if(activeSort==="alpha")items.sort((a,b)=>a.name.localeCompare(b.name));
  else if(activeSort==="oldest")items.sort((a,b)=>(a._last||"").localeCompare(b._last||""));
  else items.sort((a,b)=>(b._last||"").localeCompare(a._last||""));
  if(!items.length){grid.innerHTML='<div class="nf-empty"><div class="nf-empty-icon">&#127916;</div><p>'+(searchQ?"No results found.":"Nothing in "+(SLABELS[activeTab]||activeTab)+" yet.")+'</p></div>';return;}
  items.forEach((c,i)=>{
    const card=document.createElement("div");card.className="nf-card ripple-host";
    const posterHtml=c.poster?'<img src="'+esc(c.poster)+'" loading="lazy" alt="'+esc(c.name)+'">':'<div class="nf-card-ph"><div class="nf-card-ph-icon">🎬</div><div class="nf-card-ph-name">'+esc(c.name)+'</div></div>';
    const tagCls='nf-tag-'+c.type;
    card.innerHTML=posterHtml
      +'<div class="nf-card-tag '+tagCls+'">'+c.type+'</div>'
      +'<div class="nf-card-bottom"><div class="nf-card-name">'+esc(c.name)+'</div>'+(c._lastEp?'<div class="nf-card-lastseen">'+esc(c._lastEp)+'</div>':'')+'</div>';
    addRipple(card);
    card.addEventListener("click",()=>openDetail(c));
    grid.appendChild(card);
  });
}

/* ADD CONTENT */
async function addContent(){
  const name=document.getElementById("name").value.trim();
  const type=document.querySelector(".type-pill.sel")?.dataset.type||"movie";
  const status=document.querySelector("#addStatusPills .status-pill.sel")?.dataset.status||"ongoing";
  const url=document.getElementById("posterUrl").value.trim();
  if(!name){toast("Please enter a title","⚠️");return;}
  setSyncStatus("syncing");
  let posterUrl=url;
  if(addPosterData&&addPosterData.startsWith("data:")){
    const blob=await(await fetch(addPosterData)).blob();
    const path=currentUser.id+"/posters/"+Date.now()+".jpg";
    await sb.storage.from("media").upload(path,blob,{upsert:true});
    const{data:{publicUrl}}=sb.storage.from("media").getPublicUrl(path);
    posterUrl=publicUrl;
  }
  const{data,error}=await sb.from("content").insert({user_id:currentUser.id,name,type,poster:posterUrl||"",status,notes:""}).select().single();
  if(error){setSyncStatus("error");toast("Failed to add","⚠️");return;}
  setSyncStatus("synced");toast("Added to your list","✓");goHome();
}

/* CHANGE STATUS */
async function changeStatus(ns){
  if(!current)return;
  setSyncStatus("syncing");
  const{error}=await sb.from("content").update({status:ns,updated_at:new Date().toISOString()}).eq("id",current.id);
  if(error){setSyncStatus("error");return;}
  _cache[current.id].status=ns;current.status=ns;
  if(ns==="finished"){
    const{data:logs}=await sb.from("logs").select("*").eq("content_id",current.id).eq("completed",true);
    if(!logs||!logs.length){
      const ts=new Date().toISOString();
      await sb.from("logs").insert({user_id:currentUser.id,content_id:current.id,completed:true,timestamp:ts});
      _cache[current.id]._last=ts;current._last=ts;updateStatusUI(ns);toast("Marked Finished! 🎉","");loadHistory();
    } else {updateStatusUI(ns);toast("Status updated","✓");}
  } else {updateStatusUI(ns);toast("Status: "+SLABELS[ns],"✓");}
  setSyncStatus("synced");
}
function updateStatusUI(s){
  const p=document.getElementById("detailStatusPill");p.textContent=SLABELS[s]||s;p.className="detail-status-pill "+(SCLS[s]||"");
  document.querySelectorAll("#detailStatusPills .status-pill").forEach(x=>x.classList.toggle("sel",x.dataset.status===s));
}

/* CARD MENU */
function cardMenu(ev,c){
  closeAll();const btn=ev.currentTarget;
  const drop=document.createElement("div");drop.className="c-drop";
  drop.innerHTML='<div data-a="view">View</div><div data-a="del" class="danger">Delete</div>';
  drop.querySelector("[data-a=view]").addEventListener("click",e=>{e.stopPropagation();closeAll();openDetail(c);});
  drop.querySelector("[data-a=del]").addEventListener("click",e=>{e.stopPropagation();deleteContent(c.id);});
  drop.addEventListener("click",e=>e.stopPropagation());
  btn.appendChild(drop);activeDrop=drop;
}

/* DELETE CONTENT */
async function deleteContent(id){
  closeAll();if(!confirm("Remove from your list?"))return;
  setSyncStatus("syncing");
  await sb.from("logs").delete().eq("content_id",id);
  await sb.from("content").delete().eq("id",id);
  delete _cache[id];setSyncStatus("synced");toast("Removed","🗑");renderGrid();
}

/* OPEN DETAIL */
function openDetail(c){
  if(!c)return;current={...c};
  const poster=c.poster||PH;
  document.getElementById("detailPoster").src=poster;
  document.getElementById("detailBg").style.backgroundImage="url("+poster+")";
  document.getElementById("detailName").textContent=c.name.toUpperCase();
  document.getElementById("detailTitle").textContent=c.name.toUpperCase();
  document.getElementById("detailBadge").textContent=c.type.toUpperCase();
  document.getElementById("detailBadge").className="detail-type-badge type-"+c.type;
  updateStatusUI(c.status||"ongoing");
  document.getElementById("notesInput").value=c.notes||"";
  document.getElementById("editPanel").classList.add("hidden");
  document.getElementById("detail").scrollTop=0;
  const ps=document.getElementById("progressSection"),si=document.getElementById("seasonInput"),ei=document.getElementById("episodeInput");
  si.value="";ei.value="";
  if(c.type==="movie")ps.style.display="none";
  else if(c.type==="manga"){ps.style.display="block";si.placeholder="Volume";ei.placeholder="Chapter";}
  else{ps.style.display="block";si.placeholder="Season";ei.placeholder="Episode";}
  navigateTo("detail");loadHistory();
}

/* EDIT */
function toggleEditPanel(){
  const p=document.getElementById("editPanel");
  if(p.classList.contains("hidden")){document.getElementById("editName").value=current.name;document.getElementById("editType").value=current.type;document.getElementById("editPosterUrl").value=(current.poster&&!current.poster.startsWith("data:"))?current.poster:"";document.getElementById("editPosterFile").value="";p.classList.remove("hidden");setTimeout(()=>document.getElementById("editName").focus(),80);}
  else p.classList.add("hidden");
}
async function saveEdit(){
  const name=document.getElementById("editName").value.trim();
  const type=document.getElementById("editType").value;
  const url=document.getElementById("editPosterUrl").value.trim();
  const file=document.getElementById("editPosterFile").files[0];
  if(!name){toast("Title cannot be empty","⚠️");return;}
  setSyncStatus("syncing");
  let posterUrl=url||current.poster;
  if(file){
    const r=new FileReader();
    r.onload=async()=>{
      const blob=await(await fetch(r.result)).blob();
      const path=currentUser.id+"/posters/"+Date.now()+".jpg";
      await sb.storage.from("media").upload(path,blob,{upsert:true});
      const{data:{publicUrl}}=sb.storage.from("media").getPublicUrl(path);
      await applyEdit(name,type,publicUrl);
    };
    r.readAsDataURL(file);return;
  }
  await applyEdit(name,type,posterUrl);
}
async function applyEdit(name,type,poster){
  const{error}=await sb.from("content").update({name,type,poster:poster||"",updated_at:new Date().toISOString()}).eq("id",current.id);
  if(error){setSyncStatus("error");toast("Save failed","⚠️");return;}
  _cache[current.id]={..._cache[current.id],name,type,poster:poster||""};current={..._cache[current.id]};
  const p=poster||PH;
  document.getElementById("detailPoster").src=p;document.getElementById("detailBg").style.backgroundImage="url("+p+")";
  document.getElementById("detailName").textContent=name.toUpperCase();document.getElementById("detailTitle").textContent=name.toUpperCase();
  document.getElementById("detailBadge").textContent=type.toUpperCase();document.getElementById("detailBadge").className="detail-type-badge type-"+type;
  document.getElementById("editPanel").classList.add("hidden");
  const si=document.getElementById("seasonInput"),ei=document.getElementById("episodeInput");
  if(type==="movie")document.getElementById("progressSection").style.display="none";
  else if(type==="manga"){document.getElementById("progressSection").style.display="block";si.placeholder="Volume";ei.placeholder="Chapter";}
  else{document.getElementById("progressSection").style.display="block";si.placeholder="Season";ei.placeholder="Episode";}
  setSyncStatus("synced");toast("Saved","✓");
}

/* NOTES */
async function saveNotes(){
  if(!current)return;const notes=document.getElementById("notesInput").value;
  setSyncStatus("syncing");
  await sb.from("content").update({notes,updated_at:new Date().toISOString()}).eq("id",current.id);
  _cache[current.id].notes=notes;current.notes=notes;setSyncStatus("synced");toast("Note saved","✓");
}

/* PROGRESS */
async function addProgress(){
  const season=parseInt(document.getElementById("seasonInput").value)||1;
  const episode=parseInt(document.getElementById("episodeInput").value)||1;
  setSyncStatus("syncing");
  const{data:existing}=await sb.from("logs").select("id").eq("content_id",current.id).eq("season",season).eq("episode",episode).eq("completed",false);
  if(existing&&existing.length){toast("Already logged","ℹ️");setSyncStatus("synced");return;}
  const ts=new Date().toISOString();
  await sb.from("logs").insert({user_id:currentUser.id,content_id:current.id,season,episode,completed:false,timestamp:ts});
  await sb.from("content").update({updated_at:ts}).eq("id",current.id);
  if(!_cache[current.id]._last||ts>_cache[current.id]._last){_cache[current.id]._last=ts;current._last=ts;}
  const ep=current.type==="manga"?"Ch "+episode:"S"+season+" E"+episode;
  _cache[current.id]._lastEp=ep;current._lastEp=ep;
  setSyncStatus("synced");toast("Progress saved","✓");loadHistory();
}

/* HISTORY */
async function loadHistory(){
  const{data:logs}=await sb.from("logs").select("*").eq("content_id",current.id).order("timestamp",{ascending:true});
  const list=document.getElementById("historyList");list.innerHTML="";
  if(!logs||!logs.length){list.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:24px 0">No watch history yet</div>';return;}
  const dones=logs.filter(l=>l.completed),eps=logs.filter(l=>!l.completed);
  const isManga=current.type==="manga";
  const seasons={};
  eps.forEach(l=>{const s=l.season??1;if(!seasons[s])seasons[s]=[];seasons[s].push(l);});
  Object.keys(seasons).sort((a,b)=>Number(b)-Number(a)).forEach(s=>{
    const entries=seasons[s],lbl=isManga?"Volume "+s:"Season "+s;
    const block=document.createElement("div");block.className="season-block";
    const head=document.createElement("div");head.className="season-head";
    head.innerHTML='<div class="season-head-left"><span>'+lbl+'</span><span class="season-ep-count">'+entries.length+' '+(isManga?"ch":"ep")+(entries.length===1?"":"s")+'</span></div><span class="season-chev open">&#9660;</span>';
    const body=document.createElement("div");body.className="season-body open";
    const row=document.createElement("div");row.className="ep-pills-row";
    entries.forEach((l,i)=>{
      const pill=document.createElement("div");pill.className="ep-pill";pill.style.animationDelay=(i*30)+"ms";
      const lbl2=document.createElement("span");lbl2.textContent=isManga?l.episode:"E"+l.episode;
      const tip=document.createElement("div");tip.className="tip";tip.textContent=(isManga?"Ch ":"Ep ")+l.episode+" \u2022 "+fmtDate(l.timestamp);
      const del=document.createElement("div");del.className="ep-del";del.textContent="\u00d7";
      del.addEventListener("click",e=>{e.stopPropagation();deleteLog(l.id);});
      pill.appendChild(lbl2);pill.appendChild(tip);pill.appendChild(del);row.appendChild(pill);
    });
    body.appendChild(row);block.appendChild(head);block.appendChild(body);
    head.addEventListener("click",()=>{const o=body.classList.toggle("open");head.querySelector(".season-chev").classList.toggle("open",o);});
    list.appendChild(block);
  });
  dones.forEach(l=>{
    const row=document.createElement("div");row.className="done-row";
    row.innerHTML='<span class="dr-icon">\u2713</span><span class="dr-text">Finished</span><span class="dr-time">'+fmtDate(l.timestamp)+'</span><span class="dr-del">\u00d7</span>';
    row.querySelector(".dr-del").addEventListener("click",()=>deleteLog(l.id));
    list.appendChild(row);
  });
}
async function deleteLog(id){
  setSyncStatus("syncing");
  await sb.from("logs").delete().eq("id",id);
  const{data:rem}=await sb.from("logs").select("*").eq("content_id",current.id);
  const times=(rem||[]).map(l=>l.timestamp).filter(Boolean).sort();
  _cache[current.id]._last=times.length?times[times.length-1]:null;current._last=_cache[current.id]._last;
  const le=(rem||[]).filter(l=>!l.completed).sort((a,b)=>(b.timestamp||"").localeCompare(a.timestamp||""))[0];
  const ep=le?(current.type==="manga"?"Ch "+le.episode:"S"+(le.season||1)+" E"+le.episode):"";
  _cache[current.id]._lastEp=ep;current._lastEp=ep;
  setSyncStatus("synced");toast("Removed","🗑");loadHistory();
}

/* STATS */
async function renderStats(){
  const all=Object.values(_cache),total=all.length;
  document.getElementById("statTotal").textContent=total;
  const bs={ongoing:0,finished:0,morecoming:0,abandoned:0};
  const bt={movie:0,series:0,anime:0,manga:0};
  all.forEach(c=>{if(c.status in bs)bs[c.status]++;if(c.type in bt)bt[c.type]++;});
  ["ongoing","finished","morecoming","abandoned"].forEach(s=>{document.getElementById("stat"+cap(s)).textContent=bs[s];});
  setTimeout(()=>{["ongoing","finished","morecoming","abandoned"].forEach(s=>{document.getElementById("bar"+cap(s)).style.width=(total?Math.round(bs[s]/total*100):0)+"%";});},120);
  const maxT=Math.max(...Object.values(bt),1);
  const tr=document.getElementById("typeRows");tr.innerHTML="";
  [["movie","Movies"],["series","Series"],["anime","Anime"],["manga","Manga"]].forEach(([t,label])=>{
    const cnt=bt[t],pct=Math.round(cnt/maxT*100);
    const row=document.createElement("div");row.className="type-row";
    row.innerHTML='<div class="type-dot" style="background:'+TCLR[t]+'"></div><div class="type-n">'+label+'</div><div class="type-bar-wrap"><div class="type-bar" data-pct="'+pct+'" style="background:'+TCLR[t]+'"></div></div><div class="type-cnt">'+cnt+'</div>';
    tr.appendChild(row);
  });
  setTimeout(()=>tr.querySelectorAll(".type-bar").forEach(b=>b.style.width=b.dataset.pct+"%"),120);
  const{data:logs}=await sb.from("logs").select("*").eq("user_id",currentUser.id);
  const epl=(logs||[]).filter(l=>!l.completed);
  document.getElementById("statEps").textContent=epl.length;
  document.getElementById("statSeasons").textContent=new Set(epl.map(l=>l.content_id+"-"+(l.season||1))).size;
  const recent=all.filter(c=>c._last).sort((a,b)=>b._last.localeCompare(a._last)).slice(0,8);
  const rl=document.getElementById("recentList");rl.innerHTML="";
  recent.forEach(c=>{
    const item=document.createElement("div");item.className="recent-item";
    const thumb=c.poster?'<img class="recent-thumb" src="'+esc(c.poster)+'" alt="">':'<div class="recent-ph"></div>';
    item.innerHTML=thumb+'<div class="recent-info"><div class="recent-name">'+esc(c.name)+'</div><div class="recent-meta">'+(c._lastEp?esc(c._lastEp)+" \u2022 ":"")+fmtDate(c._last)+'</div></div><div class="recent-badge" style="background:'+TCLR[c.type]+'">'+c.type+'</div>';
    item.addEventListener("click",()=>{navigateTo("home");openDetail(c);});
    rl.appendChild(item);
  });
}

/* EXPORT / IMPORT / CLEAR */
async function exportData(){
  try{
    const[{data:content},{data:logs}]=await Promise.all([
      sb.from("content").select("*").eq("user_id",currentUser.id),
      sb.from("logs").select("*").eq("user_id",currentUser.id)
    ]);
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([JSON.stringify({content,logs},null,2)],{type:"application/json"}));
    a.download="trackr_backup_"+new Date().toISOString().split("T")[0]+".json";a.click();toast("Exported","✓");
  }catch{toast("Export failed","⚠️");}
}
async function importData(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=async()=>{
    try{
      const data=JSON.parse(r.result);
      if(!data.content||!data.logs)throw 0;
      setSyncStatus("syncing");toast("Importing "+data.content.length+" items...","⏳");

      // Build set of contentIds that have a completed log (= finished)
      const completedIds=new Set(data.logs.filter(l=>l.completed).map(l=>l.contentId||l.content_id));

      // Bulk insert content
      const contentRows=data.content.map(c=>({
        user_id:currentUser.id,
        name:c.name,
        type:c.type||"movie",
        poster:c.poster||"",
        status:c.status||(completedIds.has(c.id)?"finished":"ongoing"),
        notes:c.notes||""
      }));

      const{data:inserted,error:ce}=await sb.from("content").insert(contentRows).select("id,name");
      if(ce)throw ce;

      // Map old IDs to new IDs by name
      const nameToNewId={};
      inserted.forEach(row=>nameToNewId[row.name]=row.id);
      const oldIdToNewId={};
      data.content.forEach(c=>{if(nameToNewId[c.name])oldIdToNewId[c.id]=nameToNewId[c.name];});

      // Bulk insert logs
      const logRows=data.logs
        .filter(l=>{const oid=l.contentId||l.content_id;return oldIdToNewId[oid];})
        .map(l=>{const oid=l.contentId||l.content_id;return{
          user_id:currentUser.id,
          content_id:oldIdToNewId[oid],
          season:l.season||1,
          episode:l.episode||1,
          completed:l.completed||false,
          timestamp:l.timestamp||new Date().toISOString()
        };});

      if(logRows.length){await sb.from("logs").insert(logRows);}

      setSyncStatus("synced");toast("Imported "+inserted.length+" items!","✓");loadAll();
    }catch(err){console.error(err);setSyncStatus("error");toast("Import failed","⚠️");}
    e.target.value="";
  };r.readAsText(file);
}
async function confirmClearAll(){
  if(!confirm("Remove ALL data? This cannot be undone."))return;
  setSyncStatus("syncing");
  await sb.from("logs").delete().eq("user_id",currentUser.id);
  await sb.from("content").delete().eq("user_id",currentUser.id);
  Object.keys(_cache).forEach(k=>delete _cache[k]);
  setSyncStatus("synced");toast("Cleared","🗑");renderGrid();
}

/* NAV FUNCTIONS */
function goHome(){navigateTo("home");current=null;loadAll();}
function showAdd(){
  document.getElementById("name").value="";document.getElementById("posterUrl").value="";document.getElementById("addPosterFile").value="";document.getElementById("addPreviewWrap").classList.remove("show");addPosterData="";
  document.querySelectorAll(".type-pill").forEach(p=>p.classList.remove("sel"));document.querySelector(".type-pill[data-type='movie']").classList.add("sel");
  document.querySelectorAll("#addStatusPills .status-pill").forEach(p=>p.classList.remove("sel"));document.querySelector("#addStatusPills [data-status='ongoing']").classList.add("sel");
  navigateTo("addPage");setTimeout(()=>document.getElementById("name").focus(),350);
}
function showStats(){navigateTo("statsPage");renderStats();}

/* UTILS */
function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
function fmtDate(ts){if(!ts)return"";const d=new Date(ts);return d.toLocaleDateString()+" "+d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}

/* SERVICE WORKER */
if('serviceWorker' in navigator){
  const swCode=`const CACHE='trackr-v2';self.addEventListener('install',e=>{self.skipWaiting();});self.addEventListener('activate',e=>{e.waitUntil(clients.claim());});self.addEventListener('fetch',e=>{if(e.request.url.includes('supabase'))return;e.respondWith(caches.match(e.request).then(c=>c||fetch(e.request)));});`;
  const blob=new Blob([swCode],{type:'application/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob),{scope:'./'}).catch(()=>{});
}

/* INIT */
initAuth();
</script>
</body>
</html>